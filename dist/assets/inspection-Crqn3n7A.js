import{r as e,I as t,j as a,C as r,J as o,M as n,K as s,X as l,N as i,O as c,R as d,g as u,h as m,i as h,u as g,A as b,V as x,n as p,W as f}from"./react-vendor-B7zQ2Eq0.js";import{f as y}from"./date-vendor-CSGrVI8S.js";import{l as w,s as v,u as j}from"./admin-DR-prBnq.js";import{i as N}from"./vendor-CnJW_4UD.js";const k=[{id:"aroma",category:"aroma",label:"Aroma/Odor Level",labelGenZ:"Bau-bauan",weight:.15,icon:"Nose",iconGenZ:"üëÉ",required:!0,allowPhoto:!1,choices:{professional:{good:"Fresh/Pleasant",normal:"Neutral",bad:"Unpleasant Odor",other:"Other (specify)"},genZ:{good:"üå∏ Wangi",normal:"üòê Normal",bad:"ü§¢ Bau",other:"üí¨ Lainnya"}}},{id:"floor_cleanliness",category:"visual",label:"Floor Cleanliness",labelGenZ:"Kebersihan Lantai",weight:.12,icon:"Droplets",iconGenZ:"‚ú®",required:!0,allowPhoto:!0,choices:{professional:{good:"Clean",normal:"Acceptable",bad:"Dirty",other:"Other (specify)"},genZ:{good:"‚ú® Bersih",normal:"üòê Cukup",bad:"üí© Kotor",other:"üí¨ Lainnya"}}},{id:"wall_condition",category:"visual",label:"Wall & Tile Condition",labelGenZ:"Kondisi Dinding",weight:.08,icon:"Square",iconGenZ:"üé®",required:!0,allowPhoto:!0,choices:{professional:{good:"Clean",normal:"Acceptable",bad:"Dirty/Damaged",other:"Other (specify)"},genZ:{good:"‚ú® Bersih",normal:"üòê Cukup",bad:"üí© Kotor",other:"üí¨ Lainnya"}}},{id:"mirror_condition",category:"visual",label:"Mirror Cleanliness",labelGenZ:"Kebersihan Cermin",weight:.06,icon:"Mirror",iconGenZ:"ü™û",required:!0,allowPhoto:!1,choices:{professional:{good:"Clean",normal:"Acceptable",bad:"Dirty/Spotted",other:"Other (specify)"},genZ:{good:"‚ú® Bersih",normal:"üòê Cukup",bad:"üí© Kotor",other:"üí¨ Lainnya"}}},{id:"toilet_condition",category:"visual",label:"Toilet Bowl Condition",labelGenZ:"Kondisi Kloset",weight:.15,icon:"Droplet",iconGenZ:"üöΩ",required:!0,allowPhoto:!0,choices:{professional:{good:"Clean",normal:"Acceptable",bad:"Dirty",other:"Other (specify)"},genZ:{good:"‚ú® Bersih",normal:"üòê Cukup",bad:"üí© Kotor",other:"üí¨ Lainnya"}}},{id:"trash_bin_condition",category:"visual",label:"Trash Bin Condition",labelGenZ:"Kondisi Tempat Sampah",weight:.06,icon:"Trash2",iconGenZ:"üóëÔ∏è",required:!0,allowPhoto:!1,choices:{professional:{good:"Clean/Not Full",normal:"Half Full",bad:"Overflowing",other:"Other (specify)"},genZ:{good:"‚ú® Bersih",normal:"üòê Setengah",bad:"üò´ Penuh",other:"üí¨ Lainnya"}}},{id:"sink_condition",category:"functional",label:"Sink & Faucet Condition",labelGenZ:"Kondisi Wastafel",weight:.1,icon:"Droplet",iconGenZ:"üíß",required:!0,allowPhoto:!0,choices:{professional:{good:"Functioning Properly",normal:"Minor Issues",bad:"Not Functional",other:"Other (specify)"},genZ:{good:"‚úÖ Normal",normal:"‚ö†Ô∏è Agak Bermasalah",bad:"‚ùå Rusak",other:"üí¨ Lainnya"}}},{id:"urinal_condition",category:"functional",label:"Urinal Condition",labelGenZ:"Kondisi Urinoir",weight:.08,icon:"Droplets",iconGenZ:"üöø",required:!1,allowPhoto:!0,choices:{professional:{good:"Functioning Properly",normal:"Minor Issues",bad:"Not Functional",other:"Other (specify)"},genZ:{good:"‚úÖ Normal",normal:"‚ö†Ô∏è Agak Bermasalah",bad:"‚ùå Rusak",other:"üí¨ Lainnya"}}},{id:"soap_availability",category:"availability",label:"Soap Availability",labelGenZ:"Ketersediaan Sabun",weight:.08,icon:"Droplets",iconGenZ:"üß¥",required:!0,allowPhoto:!1,choices:{professional:{good:"Available",normal:"Low Stock",bad:"Empty",other:"Other (specify)"},genZ:{good:"‚úÖ Ada",normal:"‚ö†Ô∏è Hampir Habis",bad:"‚ùå Habis",other:"üí¨ Lainnya"}}},{id:"tissue_availability",category:"availability",label:"Tissue Availability",labelGenZ:"Ketersediaan Tissue",weight:.08,icon:"FileText",iconGenZ:"üßª",required:!0,allowPhoto:!1,choices:{professional:{good:"Available",normal:"Low Stock",bad:"Empty",other:"Other (specify)"},genZ:{good:"‚úÖ Ada",normal:"‚ö†Ô∏è Hampir Habis",bad:"‚ùå Habis",other:"üí¨ Lainnya"}}},{id:"air_freshener",category:"availability",label:"Air Freshener",labelGenZ:"Pengharum Ruangan",weight:.04,icon:"Wind",iconGenZ:"üå¨Ô∏è",required:!0,allowPhoto:!1,choices:{professional:{good:"Available",normal:"Low Stock",bad:"Empty",other:"Other (specify)"},genZ:{good:"‚úÖ Ada",normal:"‚ö†Ô∏è Hampir Habis",bad:"‚ùå Habis",other:"üí¨ Lainnya"}}}],S=e=>{let t=0,a=0;return e.forEach(e=>{const r=k.find(t=>t.id===e.component);if(!r)return;t+=r.weight;a+={good:100,normal:60,bad:20,other:40}[e.choice]*r.weight}),0===t?0:Math.round(a/t)},C=e=>e>=85?{label:"Excellent",color:"green",emoji:"üåü"}:e>=70?{label:"Good",color:"blue",emoji:"üòä"}:e>=50?{label:"Fair",color:"yellow",emoji:"üòê"}:e>=30?{label:"Poor",color:"orange",emoji:"üòü"}:{label:"Critical",color:"red",emoji:"üò®"},P=({config:n,value:s,onChange:l,onPhotoAdd:i,hasPhoto:c,genZMode:d=!1,notes:u,onNotesChange:m})=>{const[h,g]=e.useState("other"===s),b=d?n.choices.genZ:n.choices.professional,x=d?n.labelGenZ:n.label,p=!d&&n.icon?t[n.icon]:null,f=e=>{l(e),"other"===e&&g(!0)};return a.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow-sm border border-gray-100",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsxs("div",{className:"flex items-center space-x-3",children:[a.jsx("div",{className:`\n            w-12 h-12 rounded-xl flex items-center justify-center text-2xl\n            ${d?"bg-gradient-to-br from-purple-100 to-pink-100":"bg-blue-50"}\n          `,children:d?n.iconGenZ:p?a.jsx(p,{className:"w-6 h-6 text-blue-600"}):n.icon}),a.jsxs("div",{children:[a.jsxs("h3",{className:"font-semibold "+(d?"text-purple-900":"text-gray-900"),children:[x,n.required&&a.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),!n.required&&a.jsx("span",{className:"text-xs text-gray-500",children:"Optional"})]})]}),n.allowPhoto&&a.jsx("button",{type:"button",onClick:i,className:`\n              p-2 rounded-xl transition-all\n              ${c?"bg-green-100 text-green-600":d?"bg-purple-100 text-purple-600 hover:bg-purple-200":"bg-gray-100 text-gray-600 hover:bg-gray-200"}\n            `,children:a.jsx(r,{className:"w-5 h-5"})})]}),a.jsx("div",{className:"grid grid-cols-3 gap-2 mb-3",children:["good","normal","bad"].map(e=>{const t=s===e,r=_(e,t,d);return a.jsx("button",{type:"button",onClick:()=>f(e),className:`\n                py-3 px-2 rounded-xl text-center transition-all\n                border-2 font-medium text-sm\n                ${r}\n                ${t?"shadow-md scale-[1.02]":"hover:scale-[1.01]"}\n              `,children:a.jsxs("div",{className:"flex flex-col items-center space-y-1",children:[a.jsx("span",{className:"text-xl",children:F(e,n.category)}),a.jsx("span",{className:"leading-tight",children:b[e]})]})},e)})}),a.jsxs("button",{type:"button",onClick:()=>f("other"),className:`\n          w-full py-3 rounded-xl text-center transition-all\n          border-2 font-medium text-sm flex items-center justify-center space-x-2\n          ${"other"===s?d?"bg-purple-50 border-purple-400 text-purple-700":"bg-blue-50 border-blue-400 text-blue-700":"bg-gray-50 border-gray-200 text-gray-600 hover:border-gray-300"}\n        `,children:[a.jsx(o,{className:"w-4 h-4"}),a.jsx("span",{children:b.other})]}),h&&a.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-100",children:[a.jsx("textarea",{value:u||"",onChange:e=>null==m?void 0:m(e.target.value),placeholder:"other"===s?d?"Jelasin detailnya dong...":"Please specify the details...":d?"Catatan tambahan (opsional)...":"Additional notes (optional)...",className:`\n              w-full px-3 py-2 border rounded-xl focus:ring-2 resize-none\n              ${"other"===s?"border-orange-300 focus:ring-orange-500 focus:border-orange-500":"border-gray-200 focus:ring-blue-500 focus:border-blue-500"}\n            `,rows:3,required:"other"===s}),"other"!==s&&a.jsx("button",{type:"button",onClick:()=>g(!1),className:"text-sm text-gray-500 hover:text-gray-700 mt-1",children:"√ó Hide notes"})]}),s&&"other"!==s&&!h&&a.jsx("button",{type:"button",onClick:()=>g(!0),className:`\n            w-full mt-3 py-2 text-sm font-medium rounded-xl\n            ${d?"text-purple-600 hover:bg-purple-50":"text-blue-600 hover:bg-blue-50"}\n          `,children:"+ Add notes"})]})},_=(e,t,a)=>{if(!t)return"bg-white border-gray-200 text-gray-700 hover:border-gray-300 hover:bg-gray-50";if(a)switch(e){case"good":return"bg-gradient-to-br from-green-50 to-emerald-50 border-green-400 text-green-900";case"normal":return"bg-gradient-to-br from-yellow-50 to-amber-50 border-yellow-400 text-yellow-900";case"bad":return"bg-gradient-to-br from-red-50 to-pink-50 border-red-400 text-red-900";default:return"bg-white border-gray-200 text-gray-700"}else switch(e){case"good":return"bg-green-50 border-green-500 text-green-900";case"normal":return"bg-yellow-50 border-yellow-500 text-yellow-900";case"bad":return"bg-red-50 border-red-500 text-red-900";default:return"bg-white border-gray-200 text-gray-700"}},F=(e,t)=>{if("aroma"===t)switch(e){case"good":return"üå∏";case"normal":return"üòê";case"bad":return"ü§¢"}if("visual"===t)switch(e){case"good":return"‚ú®";case"normal":return"üòê";case"bad":return"üí©"}if("availability"===t)switch(e){case"good":return"‚úÖ";case"normal":return"‚ö†Ô∏è";case"bad":return"‚ùå"}if("functional"===t)switch(e){case"good":return"‚úÖ";case"normal":return"‚ö†Ô∏è";case"bad":return"‚ùå"}return"üí¨"},$=({photos:t,onPhotosChange:o,maxPhotos:c=3,genZMode:d=!1})=>{const u=e.useRef(null),[m,h]=e.useState(!1),g=t.length<c;return a.jsxs("div",{className:"space-y-3",children:[t.length>0&&a.jsx("div",{className:"grid grid-cols-2 gap-3",children:t.map((e,r)=>a.jsxs("div",{className:"relative group",children:[a.jsx("img",{src:e.preview,alt:`Photo ${r+1}`,className:"w-full h-32 object-cover rounded-xl border-2 border-gray-200"}),a.jsxs("div",{className:"absolute bottom-2 left-2 right-2 flex items-center justify-between",children:[e.location&&a.jsxs("div",{className:"bg-black/70 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-lg flex items-center space-x-1",children:[a.jsx(n,{className:"w-3 h-3"}),a.jsx("span",{children:"GPS"})]}),a.jsxs("div",{className:"bg-black/70 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-lg flex items-center space-x-1",children:[a.jsx(s,{className:"w-3 h-3"}),a.jsx("span",{children:y(new Date(e.timestamp),"HH:mm")})]})]}),a.jsx("button",{type:"button",onClick:()=>(e=>{const a=t.filter((t,a)=>a!==e);o(a)})(r),className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity shadow-lg",children:a.jsx(l,{className:"w-4 h-4"})})]},r))}),g&&a.jsx("button",{type:"button",onClick:()=>{var e;return null==(e=u.current)?void 0:e.click()},disabled:m,className:`\n            w-full h-24 border-2 border-dashed rounded-xl \n            flex flex-col items-center justify-center\n            transition-all\n            ${m?"bg-gray-100 border-gray-300 cursor-not-allowed":d?"border-purple-300 hover:border-purple-500 hover:bg-purple-50":"border-gray-300 hover:border-blue-500 hover:bg-blue-50"}\n          `,children:m?a.jsxs(a.Fragment,{children:[a.jsx(i,{className:"w-8 h-8 text-gray-400 animate-spin mb-2"}),a.jsx("span",{className:"text-sm text-gray-500",children:"Processing..."})]}):a.jsxs(a.Fragment,{children:[a.jsx(r,{className:"w-8 h-8 mb-2 "+(d?"text-purple-500":"text-gray-400")}),a.jsx("span",{className:"text-sm font-medium "+(d?"text-purple-600":"text-gray-600"),children:d?"üì∏ Foto yuk!":"Take Photo"}),a.jsxs("span",{className:"text-xs text-gray-400 mt-1",children:[t.length,"/",c," photos"]})]})}),a.jsx("input",{ref:u,type:"file",accept:"image/*",capture:"environment",onChange:async e=>{var a;const r=null==(a=e.target.files)?void 0:a[0];if(r){h(!0);try{const e=await D();let a;e&&A(e.lat,e.lng).then(e=>{a=e}).catch(()=>{});const n={file:r,preview:await I(r,{timestamp:(new Date).toISOString(),location:e?{...e,address:a}:void 0}),timestamp:(new Date).toISOString(),location:e?{...e,address:a}:void 0};o([...t,n])}catch(n){const e=URL.createObjectURL(r);o([...t,{file:r,preview:e,timestamp:(new Date).toISOString()}])}finally{h(!1),u.current&&(u.current.value="")}}},className:"hidden"}),m&&a.jsx("div",{className:"fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4",children:a.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center",children:[a.jsx("div",{className:"relative mb-6",children:a.jsxs("div",{className:"w-20 h-20 mx-auto relative",children:[a.jsx("div",{className:"absolute inset-0 border-4 border-blue-200 rounded-full"}),a.jsx("div",{className:"absolute inset-0 border-4 border-blue-600 rounded-full border-t-transparent animate-spin"}),a.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:a.jsx(r,{className:"w-8 h-8 text-blue-600"})})]})}),a.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:"Processing Photo"}),a.jsx("p",{className:"text-gray-600 mb-1",children:"Adding watermark with GPS location..."}),a.jsx("p",{className:"text-sm text-gray-500",children:"Please wait 3-4 seconds"}),a.jsxs("div",{className:"mt-6 space-y-2 text-left",children:[a.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[a.jsx("div",{className:"w-2 h-2 bg-blue-600 rounded-full animate-pulse"}),a.jsx("span",{children:"Getting GPS coordinates..."})]}),a.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[a.jsx("div",{className:"w-2 h-2 bg-blue-400 rounded-full animate-pulse",style:{animationDelay:"0.2s"}}),a.jsx("span",{children:"Applying watermark..."})]}),a.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[a.jsx("div",{className:"w-2 h-2 bg-blue-300 rounded-full animate-pulse",style:{animationDelay:"0.4s"}}),a.jsx("span",{children:"Finalizing image..."})]})]})]})})]})},D=()=>new Promise(e=>{"geolocation"in navigator?navigator.geolocation.getCurrentPosition(t=>{e({lat:t.coords.latitude,lng:t.coords.longitude})},()=>e(null),{timeout:5e3}):e(null)}),A=async(e,t)=>{try{const a=new AbortController,r=setTimeout(()=>a.abort(),3e3),o=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${e}&lon=${t}&format=json`,{headers:{"User-Agent":"ToiletCheck/1.0"},signal:a.signal});if(clearTimeout(r),!o.ok)return;return(await o.json()).display_name}catch(a){return void a.name}},I=async(e,t)=>new Promise(a=>{const r=new Image,o=new FileReader;o.onload=e=>{var t;r.src=null==(t=e.target)?void 0:t.result},r.onload=()=>{const o=document.createElement("canvas");o.width=r.width,o.height=r.height;const n=o.getContext("2d");if(!n)return void a(URL.createObjectURL(e));n.drawImage(r,0,0);n.fillStyle="rgba(0, 0, 0, 0.6)",n.fillRect(0,o.height-60,o.width,60),n.fillStyle="white",n.font="bold 16px Arial";const s=y(new Date(t.timestamp),"dd/MM/yyyy HH:mm:ss");n.fillText(s,10,o.height-35),t.location&&(n.font="14px Arial",n.fillText(`üìç ${t.location.lat.toFixed(5)}, ${t.location.lng.toFixed(5)}`,10,o.height-10)),a(o.toDataURL("image/jpeg",.9))},o.readAsDataURL(e)}),q=({photos:t,onPhotosChange:o,maxPhotos:i=5,genZMode:u=!1,locationName:m})=>{const h=e.useRef(null),g=e.useRef(null),[b,x]=e.useState(!1),[p,f]=e.useState(null),w=t.length<i;return a.jsxs("div",{className:"space-y-3",children:[t.length>0&&a.jsx("div",{className:"grid grid-cols-2 gap-3",children:t.map((e,r)=>a.jsxs("div",{className:"relative group",children:[a.jsx("img",{src:e.preview,alt:`Photo ${r+1}`,className:"w-full aspect-[4/3] object-cover rounded-xl border-2 border-gray-200"}),a.jsxs("div",{className:"absolute bottom-2 left-2 right-2 flex items-center justify-between gap-1",children:[e.geolocation&&a.jsxs("div",{className:"bg-black/70 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-lg flex items-center space-x-1",children:[a.jsx(n,{className:"w-3 h-3"}),a.jsx("span",{children:"GPS"})]}),a.jsxs("div",{className:"bg-black/70 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-lg flex items-center space-x-1",children:[a.jsx(s,{className:"w-3 h-3"}),a.jsx("span",{children:y(new Date(e.timestamp),"HH:mm")})]})]}),a.jsx("button",{type:"button",onClick:()=>(e=>{const a=t.filter((t,a)=>a!==e);o(a)})(r),className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1.5 opacity-0 group-hover:opacity-100 transition-opacity shadow-lg",children:a.jsx(l,{className:"w-4 h-4"})})]},r))}),p&&a.jsxs("div",{className:"bg-orange-50 border border-orange-200 rounded-xl p-3 flex items-start space-x-2",children:[a.jsx(c,{className:"w-5 h-5 text-orange-600 flex-shrink-0 mt-0.5"}),a.jsx("p",{className:"text-sm text-orange-800",children:p})]}),w&&a.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[a.jsxs("button",{type:"button",onClick:()=>{var e;return null==(e=h.current)?void 0:e.click()},disabled:b,className:`\n              py-5 border-2 border-dashed rounded-xl\n              flex flex-col items-center justify-center space-y-2\n              transition-all\n              ${b?"bg-gray-50 border-gray-300 cursor-wait":u?"border-purple-300 bg-purple-50 hover:border-purple-400 hover:bg-purple-100 text-purple-700":"border-blue-300 bg-blue-50 hover:border-blue-400 hover:bg-blue-100 text-blue-700"}\n            `,children:[a.jsx(r,{className:"w-7 h-7"}),a.jsxs("div",{className:"text-center",children:[a.jsx("p",{className:"text-sm font-semibold",children:u?"üì∏ Kamera":"üì∏ Camera"}),a.jsx("p",{className:"text-xs opacity-75",children:u?"Ambil foto":"Take photo"})]})]}),a.jsxs("button",{type:"button",onClick:()=>{var e;return null==(e=g.current)?void 0:e.click()},disabled:b,className:`\n              py-5 border-2 border-dashed rounded-xl\n              flex flex-col items-center justify-center space-y-2\n              transition-all\n              ${b?"bg-gray-50 border-gray-300 cursor-wait":u?"border-purple-300 bg-purple-50 hover:border-purple-400 hover:bg-purple-100 text-purple-700":"border-green-300 bg-green-50 hover:border-green-400 hover:bg-green-100 text-green-700"}\n            `,children:[a.jsx(d,{className:"w-7 h-7"}),a.jsxs("div",{className:"text-center",children:[a.jsx("p",{className:"text-sm font-semibold",children:u?"üñºÔ∏è Galeri":"üñºÔ∏è Gallery"}),a.jsx("p",{className:"text-xs opacity-75",children:u?"Pilih file":"Choose file"})]})]})]}),a.jsx("input",{ref:h,type:"file",accept:"image/*",capture:"environment",onChange:async e=>{var a;const r=null==(a=e.target.files)?void 0:a[0];if(r){x(!0),f(null);try{const e=await L();let a;e&&O(e.lat,e.lng).then(e=>{a=e}).catch(()=>{});const n=await Z(r,{timestamp:(new Date).toISOString(),location:e?{...e,address:a}:void 0,locationName:m}),s=URL.createObjectURL(n),l={file:new File([n],r.name,{type:"image/jpeg"}),preview:s,timestamp:(new Date).toISOString(),geolocation:e};o([...t,l]),"vibrate"in navigator&&navigator.vibrate(100)}catch(n){const e=URL.createObjectURL(r);o([...t,{file:r,preview:e,timestamp:(new Date).toISOString()}]),f(u?"Foto ditambah tanpa watermark":"Photo added without watermark")}finally{x(!1),h.current&&(h.current.value="")}}},className:"hidden"}),a.jsx("input",{ref:g,type:"file",accept:"image/*",onChange:async e=>{var a;const r=null==(a=e.target.files)?void 0:a[0];if(r){x(!0),f(null);try{let e,a=null;try{a=await L()}catch(n){}a&&O(a.lat,a.lng).then(t=>{e=t}).catch(()=>{});const s=await Z(r,{timestamp:(new Date).toISOString(),location:a?{...a,address:e}:void 0,locationName:m}),l=URL.createObjectURL(s),i={file:new File([s],r.name,{type:"image/jpeg"}),preview:l,timestamp:(new Date).toISOString(),geolocation:a};o([...t,i])}catch(s){const e=URL.createObjectURL(r);o([...t,{file:r,preview:e,timestamp:(new Date).toISOString()}]),f(u?"Foto ditambah tanpa watermark":"Photo added without watermark")}finally{x(!1),g.current&&(g.current.value="")}}},className:"hidden"}),w&&a.jsxs("div",{className:"text-center space-y-1",children:[a.jsxs("p",{className:"text-xs text-gray-600 font-medium",children:[t.length,"/",i," photos"]}),a.jsx("p",{className:"text-xs text-gray-500",children:u?"‚ú® Watermark otomatis: Tanggal, Jam & Lokasi":"‚ú® Auto watermark: Date, Time & Location"})]}),b&&a.jsx("div",{className:"fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4",children:a.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center",children:[a.jsx("div",{className:"relative mb-6",children:a.jsxs("div",{className:"w-20 h-20 mx-auto relative",children:[a.jsx("div",{className:"absolute inset-0 border-4 border-blue-200 rounded-full"}),a.jsx("div",{className:"absolute inset-0 border-4 border-blue-600 rounded-full border-t-transparent animate-spin"}),a.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:a.jsx(r,{className:"w-8 h-8 text-blue-600"})})]})}),a.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:u?"Memproses Foto":"Processing Photo"}),a.jsx("p",{className:"text-gray-600 mb-1",children:u?"Menambahkan watermark...":"Adding watermark..."}),a.jsx("p",{className:"text-sm text-gray-500",children:u?"Tunggu sebentar":"Please wait"})]})})]})},L=()=>new Promise(e=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(t=>{e({lat:t.coords.latitude,lng:t.coords.longitude})},t=>{e(null)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0}):e(null)}),O=async(e,t)=>{try{const a=new AbortController,r=setTimeout(()=>a.abort(),3e3),o=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${t}&zoom=18`,{headers:{"User-Agent":"ToiletCheck/1.0"},signal:a.signal});if(clearTimeout(r),!o.ok)return;const n=(await o.json()).address;return[n.road,n.suburb||n.neighbourhood,n.city||n.county].filter(Boolean).slice(0,2).join(", ")}catch(a){return void a.name}},Z=async(e,t)=>new Promise((a,r)=>{const o=new FileReader;o.onload=e=>{var o;const n=new Image;n.src=null==(o=e.target)?void 0:o.result,n.onload=()=>{var e;const o=document.createElement("canvas");o.width=n.width,o.height=n.height;const s=o.getContext("2d");if(!s)return void r(new Error("Could not get canvas context"));s.drawImage(n,0,0);const l=Math.max(20,.03*n.width),i=Math.max(20,.025*n.width),c=y(new Date(t.timestamp),"dd/MM/yyyy"),d=y(new Date(t.timestamp),"HH:mm:ss"),u=[`üìç ${t.locationName}`,`üìÖ ${c} ‚è∞ ${d}`];(null==(e=t.location)?void 0:e.address)?u.push(`üó∫Ô∏è ${t.location.address}`):t.location&&u.push(`üß≠ ${t.location.lat.toFixed(6)}, ${t.location.lng.toFixed(6)}`),s.font=`bold ${l}px Arial, sans-serif`;const m=Math.max(...u.map(e=>s.measureText(e).width)),h=1.4*l,g=u.length*h+2*i;s.fillStyle="rgba(0, 0, 0, 0.85)",s.fillRect(i,n.height-g-i,m+3*i,g),s.fillStyle="#FFFFFF",s.font=`bold ${l}px Arial, sans-serif`,u.forEach((e,t)=>{s.fillText(e,2*i,n.height-g-i+h*(t+1))}),s.font=`bold ${.9*l}px Arial, sans-serif`,s.fillStyle="rgba(255, 255, 255, 0.7)";const b="TOILET CHECK ‚úì",x=s.measureText(b).width;s.fillStyle="rgba(0, 0, 0, 0.6)",s.fillRect(n.width-x-3*i,i,x+2*i,1.8*h),s.fillStyle="rgba(255, 255, 255, 0.95)",s.fillText(b,n.width-x-2*i,i+1.2*h),o.toBlob(e=>{e?a(e):r(new Error("Failed to create watermarked photo"))},"image/jpeg",.92)},n.onerror=()=>r(new Error("Failed to load image"))},o.onerror=()=>r(new Error("Failed to read file")),o.readAsDataURL(e)});(()=>{const e=[];if(e.length>0)throw new Error(`Missing required Cloudinary environment variables: ${e.join(", ")}\nPlease check your .env file and ensure all variables are set.`)})();const T=async e=>{const t={maxSizeMB:.5,maxWidthOrHeight:1920,useWebWorker:!0,fileType:"image/webp"};try{return await N(e,t)}catch(a){return e}},M=async e=>{var t;const a=new FormData;a.append("file",e),a.append("upload_preset","toilet-checks"),a.append("folder","toilet-inspections");try{const e=await fetch("https://api.cloudinary.com/v1_1/dcg56qkae/image/upload",{method:"POST",body:a}),r=await e.json();if(!e.ok)throw new Error((null==(t=r.error)?void 0:t.message)||"Upload failed");return r.secure_url}catch(r){throw new Error("Failed to upload photo")}},G=({locationId:t})=>{const o=!1,n=g(),{user:s,profile:l}=j(),{getLocation:i,submitInspection:d}=(e=>{const t=u(),a=m({queryKey:["inspection",e],queryFn:async()=>null,enabled:!1}),r=m({queryKey:["default-template"],queryFn:async()=>{const{data:e,error:t}=await v.from("inspection_templates").select("*").eq("is_default",!0).eq("is_active",!0).single();return t?(w.warn("Using fallback template",t),{id:"comprehensive-template",name:"Comprehensive Inspection",description:"Default comprehensive inspection template",fields:{components:[],requiredPhotos:0,maxPhotos:10,allowNotes:!0},estimated_time:300,is_active:!0,is_default:!0,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}):e},retry:1}),o=h({mutationFn:async e=>{var t;const a=w.startTimer("Submit inspection"),{location_id:o,user_id:n,responses:s,photo_urls:l,notes:i,duration_seconds:c}=e;if(!o||!n)throw new Error("Location ID and User ID are required");w.info("Submitting inspection with photos",{photo_count:l.length});let d="comprehensive-template";try{const e=await r.refetch();(null==(t=e.data)?void 0:t.id)&&(d=e.data.id)}catch(j){w.warn("Using fallback template ID")}const u=new Date,m=u.toISOString().split("T")[0],h=u.toTimeString().split(" ")[0],g=u.toISOString(),b=s.score||0;let x="satisfactory";x=b>=90?"excellent":b>=75?"good":b>=60?"fair":b>=40?"poor":"very_poor";const p={location_id:o,user_id:n,template_id:d,inspection_date:m,inspection_time:h,overall_status:x,responses:s,photo_urls:l.length>0?l:null,notes:(null==i?void 0:i.trim())||null,submitted_at:g,duration_seconds:c||null,verification_notes:null,verified_at:null,verified_by:null};w.info("Saving inspection to database",{location_id:o,photos:l.length,score:b});const{data:f,error:y}=await v.from("inspection_records").insert(p).select("id, location_id, overall_status, submitted_at").single();if(y)throw a(),w.error("Failed to submit inspection",y),new Error(`Failed to submit inspection: ${y.message}`);return a(),w.info("Inspection submitted successfully",{id:f.id}),f},onSuccess:()=>{t.invalidateQueries({queryKey:["inspections"]}),t.invalidateQueries({queryKey:["location-inspections"]}),t.invalidateQueries({queryKey:["dashboard-stats"]})},onError:e=>{w.error("Inspection mutation failed",e)}});return{getInspection:a,getDefaultTemplate:r,getLocation:e=>m({queryKey:["location",e],queryFn:async()=>{if(!e)throw new Error("Location ID is required");const{data:t,error:a}=await v.from("locations_with_details").select("*").eq("id",e).single();if(a)throw w.error("Failed to fetch location",a),new Error(`Failed to fetch location: ${a.message}`);return t},enabled:!!e}),submitInspection:o,getLocationInspections:e=>m({queryKey:["location-inspections",e],queryFn:async()=>{if(!e)return[];const{data:t,error:a}=await v.from("inspection_records").select("\n          *,\n          users:user_id (\n            full_name,\n            email\n          )\n        ").eq("location_id",e).order("submitted_at",{ascending:!1});if(a)throw w.error("Failed to fetch location inspections",a),new Error(`Failed to fetch inspections: ${a.message}`);return t},enabled:!!e})}})(),f=e.useRef(!0),y=e.useRef(null),[N,C]=e.useState(new Map),[_,F]=e.useState(new Map),[D,A]=e.useState([]),[I,L]=e.useState(""),[O,Z]=e.useState(!1),[G,R]=e.useState(""),[U,E]=e.useState(!1),[K,H]=e.useState(null),[z,B]=e.useState("low"),[W,Q]=e.useState(!1),[J]=e.useState(new Date),[V,X]=e.useState(0),[Y,ee]=e.useState(k[0].id),{data:te,isLoading:ae}=i(t);e.useEffect(()=>()=>{f.current=!1,y.current&&clearTimeout(y.current)},[]),e.useEffect(()=>{const e=Array.from(N.values());if(e.length>0){const t=S(e);X(t)}},[N]);if(ae)return a.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:a.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})});if(!te)return a.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center p-4",children:a.jsxs("div",{className:"text-center",children:[a.jsx(c,{className:"w-12 h-12 text-red-500 mx-auto mb-2"}),a.jsx("p",{className:"text-gray-700",children:"Location not found"})]})});const re=N.size,oe=k.filter(e=>e.required).length,ne=re/k.length*100;return a.jsxs("div",{className:"min-h-screen pb-32 bg-gray-50",children:[a.jsx("div",{className:"\n        sticky top-0 z-20\n        bg-white border-b border-gray-200\n        shadow-sm\n      ",children:a.jsxs("div",{className:"p-4",children:[a.jsx("div",{className:"flex items-center justify-between mb-3",children:a.jsx("button",{onClick:()=>n(-1),className:"p-2 rounded-xl bg-gray-100 text-gray-700",children:a.jsx(b,{className:"w-5 h-5"})})}),a.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[a.jsx("div",{className:"\n              w-12 h-12 rounded-xl flex items-center justify-center text-2xl\n              bg-blue-100\n            ",children:"üöΩ"}),a.jsxs("div",{className:"text-gray-900",children:[a.jsx("h1",{className:"font-bold text-lg",children:te.name}),a.jsxs("p",{className:"text-sm text-gray-600",children:[te.building," ‚Ä¢ ",te.floor," ‚Ä¢ ",te.area]})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex items-center justify-between text-sm",children:[a.jsx("span",{className:"text-gray-600",children:`${re} of ${k.length} completed`}),V>0&&a.jsxs("span",{className:"font-bold text-blue-600",children:["Score: ",V]})]}),a.jsx("div",{className:"w-full h-2 bg-white/20 rounded-full overflow-hidden",children:a.jsx("div",{className:"h-full transition-all duration-300 bg-blue-600",style:{width:`${ne}%`}})})]})]})}),a.jsxs("div",{className:"p-4 space-y-4",children:[k.map(e=>{const t=N.get(e.id),r=_.get(e.id)||[],n=Y===e.id;return a.jsxs("div",{children:[n?a.jsx(P,{config:e,value:(null==t?void 0:t.choice)||null,onChange:t=>((e,t)=>{const a=N.get(e)||{component:e,choice:"good"};C(new Map(N.set(e,{...a,choice:t})));const r=k.findIndex(t=>t.id===e);if(r<k.length-1){const e=k[r+1];N.has(e.id)||ee(e.id)}else ee(null)})(e.id,t),onPhotoAdd:e.allowPhoto?()=>{}:void 0,hasPhoto:r.length>0,genZMode:o,notes:null==t?void 0:t.notes,onNotesChange:t=>((e,t)=>{const a=N.get(e);a&&C(new Map(N.set(e,{...a,notes:t})))})(e.id,t)}):a.jsxs("button",{type:"button",onClick:()=>ee(e.id),className:`\n                    w-full p-4 rounded-2xl flex items-center justify-between\n                    transition-all border-2\n                    ${t?"bg-green-50 border-green-500":"bg-white border-gray-200 hover:border-gray-300"}\n                  `,children:[a.jsxs("div",{className:"flex items-center space-x-3",children:[a.jsx("span",{className:"text-2xl",children:e.iconGenZ}),a.jsx("span",{className:"font-medium text-gray-900",children:e.label})]}),t?a.jsx(x,{className:"w-5 h-5 text-green-600"}):e.required?a.jsx("span",{className:"text-red-500",children:"*"}):null]}),n&&e.allowPhoto&&a.jsx("div",{className:"mt-3",children:a.jsx($,{componentId:e.id,photos:r,onPhotosChange:t=>{return a=e.id,r=t,void F(new Map(_.set(a,r)));var a,r},genZMode:o})}),n&&a.jsx("button",{type:"button",onClick:()=>ee(null),className:"\n                    w-full mt-2 py-2 rounded-xl text-sm font-medium\n                    bg-gray-100 text-gray-700 hover:bg-gray-200\n                  ",children:"‚Üë Collapse"})]},e.id)}),re>=oe&&a.jsxs("div",{className:"bg-blue-50 rounded-2xl p-4 shadow-sm border-2 border-blue-400",children:[a.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[a.jsx(r,{className:"w-5 h-5 text-blue-700"}),a.jsxs("h3",{className:"font-bold text-gray-900",children:["üì∏ Documentation Photos",a.jsx("span",{className:"text-red-500 ml-1",children:"*"})]})]}),a.jsx("p",{className:"text-sm mb-4 text-blue-900",children:"‚ö†Ô∏è REQUIRED: Minimum 1 photo! Auto watermark: Date, Time, GPS, Toilet Name."}),a.jsx(q,{photos:D,onPhotosChange:A,maxPhotos:5,genZMode:o,locationName:`${te.name} - ${te.building}`})]}),a.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow-sm border border-gray-100",children:[a.jsxs("label",{className:"flex items-center justify-between mb-3",children:[a.jsx("span",{className:"font-semibold text-gray-900",children:"Issues Found?"}),a.jsx("input",{type:"checkbox",checked:O,onChange:e=>Z(e.target.checked),className:"w-5 h-5 text-blue-600 rounded focus:ring-blue-500"})]}),O&&a.jsx("textarea",{value:G,onChange:e=>R(e.target.value),placeholder:"Describe the issues found...",className:"w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 resize-none",rows:3})]}),a.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow-sm border border-gray-100",children:[a.jsxs("label",{className:"flex items-center justify-between mb-3",children:[a.jsx("span",{className:"font-semibold text-gray-900",children:"Requires Maintenance?"}),a.jsx("input",{type:"checkbox",checked:U,onChange:e=>E(e.target.checked),className:"w-5 h-5 text-blue-600 rounded focus:ring-blue-500"})]}),U&&a.jsx("div",{className:"grid grid-cols-2 gap-2",children:["low","medium","high","urgent"].map(e=>a.jsx("button",{type:"button",onClick:()=>B(e),className:`\n                    py-2 px-3 rounded-xl text-sm font-medium capitalize\n                    ${z===e?"urgent"===e?"bg-red-100 text-red-700 border-2 border-red-500":"high"===e?"bg-orange-100 text-orange-700 border-2 border-orange-500":"medium"===e?"bg-yellow-100 text-yellow-700 border-2 border-yellow-500":"bg-blue-100 text-blue-700 border-2 border-blue-500":"bg-gray-100 text-gray-700 border-2 border-gray-200"}\n                  `,children:e},e))})]}),a.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow-sm border border-gray-100",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"General Notes (Optional)"}),a.jsx("textarea",{value:I,onChange:e=>L(e.target.value),placeholder:"Any additional observations...",className:"w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 resize-none",rows:3})]})]}),K&&a.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4",children:a.jsxs("div",{className:"bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl",children:[a.jsxs("div",{className:"text-center mb-4",children:[a.jsx("div",{className:"w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3",children:a.jsxs("svg",{className:"w-8 h-8 text-blue-600 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[a.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),a.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}),a.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-1",children:"Uploading Photos..."}),a.jsxs("p",{className:"text-sm text-gray-600",children:[(null==K?void 0:K.current)||0," of ",(null==K?void 0:K.total)||0," photos"]})]}),a.jsxs("div",{className:"relative",children:[a.jsx("div",{className:"h-3 bg-gray-200 rounded-full overflow-hidden",children:a.jsx("div",{className:"h-full bg-gradient-to-r from-blue-500 to-blue-600 transition-all duration-300 ease-out",style:{width:`${(null==K?void 0:K.percentage)||0}%`}})}),a.jsx("div",{className:"mt-2 text-center",children:a.jsxs("span",{className:"text-2xl font-bold text-blue-600",children:[(null==K?void 0:K.percentage)||0,"%"]})})]}),a.jsx("p",{className:"text-xs text-gray-500 text-center mt-4",children:"Please wait while we upload your photos..."})]})}),a.jsxs("div",{className:"fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200 shadow-lg",children:[a.jsx("button",{type:"button",onClick:async()=>{var e;if(s){if((()=>{const e=k.filter(e=>e.required).filter(e=>!N.has(e.id));if(e.length>0){const t=e.map(e=>e.label).join(", ");return p.error(`Please rate: ${t}`),ee(e[0].id),!1}const t=Array.from(N.values()).filter(e=>{var t;return"other"===e.choice&&!(null==(t=e.notes)?void 0:t.trim())});if(t.length>0){const e=k.find(e=>e.id===t[0].component);return p.error(`"${null==e?void 0:e.label}" requires explanation when selecting "Other"`),ee(t[0].component),!1}return 0===D.length?(p.error("üì∏ At least 1 documentation photo is required!"),!1):O&&!G.trim()?(p.error("Please describe the issues found"),!1):!(U&&!z&&(p.error("Please select maintenance priority"),1))})()){Q(!0);try{const a=new Date,r=Math.floor((a.getTime()-J.getTime())/1e3),o=[];for(const[e,t]of _.entries())for(const a of t)o.push(a.file);const i=D.map(e=>e.file),c=[...o,...i],u=c.length;if(0===u)return void p.error("Please add at least one photo");const m=p.loading(`üóúÔ∏è Compressing ${u} photos...`);H({current:0,total:u,percentage:0});const h=[];for(let e=0;e<c.length;e++){const t=await T(c[e]);if(h.push(t),f.current){const t=Math.round((e+1)/u*50);H({current:e+1,total:u,percentage:t})}}p.loading(`‚òÅÔ∏è Uploading ${u} photos...`,{id:m});const g=await(async(e,t)=>{const a=[],r=[];let o=0;for(let n=0;n<e.length;n+=3){const s=e.slice(n,n+3);(await Promise.allSettled(s.map((e,t)=>M(e).catch(t=>{throw r.push({fileName:e.name,error:t.message||"Unknown error"}),t})))).forEach((e,t)=>{"fulfilled"===e.status&&a.push(e.value)}),o+=s.length,t&&t(o,e.length)}return r.length,a})(h,(e,t)=>{if(f.current){const a=50+Math.round(e/t*50);H({current:e,total:t,percentage:a}),p.loading(`‚òÅÔ∏è Uploading ${e}/${t} photos...`,{id:m})}});p.loading("üíæ Saving inspection...",{id:m}),H(null);const b=new Map(N);let x=0;for(const[e,t]of _.entries()){const a=b.get(e);a&&t.length>0&&(a.photo=g[x],b.set(e,a),x+=t.length)}const w={ratings:Array.from(b.values()),score:V,issues_found:O,issue_description:O?G.trim():null,requires_maintenance:U,maintenance_priority:U?z:null,inspection_mode:"professional",submitted_at:(new Date).toISOString(),inspector:{id:s.id,name:(null==l?void 0:l.full_name)||(null==(e=s.email)?void 0:e.split("@")[0])||"Unknown",email:s.email,profile_id:null==l?void 0:l.id}};await d.mutateAsync({location_id:t,user_id:s.id,responses:w,photo_urls:g,notes:I.trim()||void 0,duration_seconds:r}),p.success(`‚úÖ Inspection saved! Score: ${V}`,{id:m,duration:2e3}),y.current=setTimeout(()=>{f.current&&n("/",{replace:!0})},1500)}catch(a){H(null),p.error(a.message||"Failed to submit inspection")}finally{Q(!1),H(null)}}}else p.error("Please login first")},disabled:W||re<oe||0===D.length,className:`\n            w-full py-4 rounded-xl font-bold text-white transition-all\n            ${W||re<oe||0===D.length?"bg-gray-300 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"}\n          `,children:W?((null==K?void 0:K.total)||0)>0?`Uploading ${(null==K?void 0:K.current)||0}/${(null==K?void 0:K.total)||0} photos...`:"Submitting...":`Submit Inspection (Score: ${V})`}),(re<oe||0===D.length)&&a.jsxs("div",{className:"text-center text-sm text-red-600 mt-2 space-y-1",children:[re<oe&&a.jsx("p",{children:`‚ùå ${oe-re} required components remaining`}),0===D.length&&a.jsx("p",{children:"üì∏ At least 1 documentation photo required"})]})]})]})},R=Object.freeze(Object.defineProperty({__proto__:null,InspectionPage:()=>{const{locationId:e}=f();return e?a.jsx(G,{locationId:e}):a.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center p-4",children:a.jsxs("div",{className:"text-center",children:[a.jsx(c,{className:"w-12 h-12 text-red-500 mx-auto mb-3"}),a.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"Invalid Location"}),a.jsx("p",{className:"text-gray-600",children:"No location ID provided in URL"})]})})}},Symbol.toStringTag,{value:"Module"}));export{k as I,R as a,S as c,C as g};
