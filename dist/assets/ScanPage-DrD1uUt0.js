import{r as e,n as t,j as a,X as s,ag as r,ah as i,v as n,ai as l,f as c,a as o,O as d,d as x,M as m,m as h,x as u,z as b}from"./react-vendor-B_wON18L.js";import{u as g,s as p}from"./admin-DxXcpQLf.js";import{D as f}from"./vendor-C4HD8sBH.js";import{S as v}from"./reports-CYvdUc55.js";import{f as j}from"./date-vendor-DWqTPjCA.js";import"./supabase-vendor-Ck00pQO2.js";import"./inspection-Bd6L4SDO.js";const w=({isOpen:c,onClose:o,onScan:d})=>{const x=e.useRef(null),m=e.useRef(null),h=e.useRef(null),u=e.useRef(null),[b,g]=e.useState(!1),[p,v]=e.useState(null),[j,w]=e.useState(!1),[y,N]=e.useState(!1),[_,C]=e.useState(!1),k=e.useCallback(()=>{const e=x.current,a=m.current;if(!e||!a||e.readyState!==e.HAVE_ENOUGH_DATA)return void(u.current=requestAnimationFrame(k));const s=a.getContext("2d",{willReadFrequently:!0});if(!s)return;a.width=e.videoWidth,a.height=e.videoHeight,s.drawImage(e,0,0,a.width,a.height);const r=s.getImageData(0,0,a.width,a.height),i=f(r.data,r.width,r.height,{inversionAttempts:"dontInvert"});if(i){const e=(e=>{try{if(e.includes("/locations/")){const t=e.match(/locations\/([0-9a-f-]{36})/i);return t?t[1]:null}return/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)?e:null}catch(t){return null}})(i.data);if(e)return"vibrate"in navigator&&navigator.vibrate(200),t.success("Valid QR Code!"),d(e),void R();"vibrate"in navigator&&navigator.vibrate([100,50,100]),t.error("Invalid QR code format")}u.current=requestAnimationFrame(k)},[d]),S=e.useCallback(async()=>{try{g(!0),v(null);const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"},width:{ideal:1280},height:{ideal:720}}});h.current=e;const t=e.getVideoTracks()[0];t.getCapabilities().torch&&C(!0),x.current&&(x.current.srcObject=e,x.current.setAttribute("playsinline","true"),await x.current.play(),w(!0),g(!1),k())}catch(e){if("NotAllowedError"===e.name)v("âŒ Camera permission denied. Please enable camera in browser settings.");else if("NotFoundError"===e.name)v("âŒ No camera found on this device.");else if("NotReadableError"===e.name)v("âŒ Camera is being used by another app. Please close other apps and try again.");else if("OverconstrainedError"===e.name)try{const e=await navigator.mediaDevices.getUserMedia({video:!0});h.current=e,x.current&&(x.current.srcObject=e,x.current.setAttribute("playsinline","true"),await x.current.play(),w(!0),g(!1),k())}catch{v("âŒ Camera initialization failed. Please try again.")}else v("âŒ Camera initialization failed. Please try again.");g(!1)}},[k]),R=e.useCallback(()=>{u.current&&(cancelAnimationFrame(u.current),u.current=null),h.current&&(h.current.getTracks().forEach(e=>e.stop()),h.current=null),x.current&&(x.current.srcObject=null),w(!1),g(!1),N(!1)},[]);e.useEffect(()=>(c?S():R(),()=>{R()}),[c,S,R]);const T=()=>{R(),o()};return c?a.jsxs("div",{className:"fixed inset-0 bg-black z-50 flex flex-col",children:[a.jsx("video",{ref:x,className:"absolute inset-0 w-full h-full object-cover",playsInline:!0,muted:!0}),a.jsx("canvas",{ref:m,className:"hidden"}),j&&a.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:a.jsxs("div",{className:"relative w-64 h-64",children:[a.jsx("div",{className:"absolute top-0 left-0 w-12 h-12 border-t-4 border-l-4 border-white rounded-tl-2xl"}),a.jsx("div",{className:"absolute top-0 right-0 w-12 h-12 border-t-4 border-r-4 border-white rounded-tr-2xl"}),a.jsx("div",{className:"absolute bottom-0 left-0 w-12 h-12 border-b-4 border-l-4 border-white rounded-bl-2xl"}),a.jsx("div",{className:"absolute bottom-0 right-0 w-12 h-12 border-b-4 border-r-4 border-white rounded-br-2xl"}),a.jsx("div",{className:"absolute inset-0 overflow-hidden",children:a.jsx("div",{className:"absolute w-full h-1 bg-gradient-to-r from-transparent via-white to-transparent animate-scan"})})]})}),a.jsxs("div",{className:"absolute top-4 left-4 right-4 z-10 flex items-center justify-between",children:[a.jsx("button",{onClick:T,className:"bg-white/90 backdrop-blur-sm rounded-full p-3 shadow-lg active:scale-95 transition-transform",children:a.jsx(s,{className:"w-6 h-6 text-gray-700"})}),_&&j&&a.jsx("button",{onClick:async()=>{if(h.current)try{const e=h.current.getVideoTracks()[0],a=!y;await e.applyConstraints({advanced:[{torch:a}]}),N(a),t.success(a?"Flashlight ON":"Flashlight OFF")}catch(e){t.error("Flashlight not available")}},className:"backdrop-blur-sm rounded-full p-3 shadow-lg active:scale-95 transition-all "+(y?"bg-yellow-400":"bg-white/90"),children:y?a.jsx(r,{className:"w-6 h-6 text-gray-700"}):a.jsx(i,{className:"w-6 h-6 text-gray-700"})})]}),j&&a.jsx("div",{className:"absolute bottom-8 left-0 right-0 text-center px-6 z-10",children:a.jsxs("div",{className:"bg-black/60 backdrop-blur-sm rounded-2xl p-4 max-w-md mx-auto",children:[a.jsx(n,{className:"w-8 h-8 text-white mx-auto mb-2"}),a.jsx("p",{className:"text-white text-lg font-medium mb-1",children:"Scan QR Code"}),a.jsx("p",{className:"text-gray-300 text-sm",children:"Point camera at location QR code"})]})}),b&&a.jsx("div",{className:"absolute inset-0 bg-black/80 flex items-center justify-center z-20",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-4 border-white border-t-transparent mx-auto mb-4"}),a.jsx("p",{className:"text-white text-lg font-medium",children:"Initializing camera..."}),a.jsx("p",{className:"text-gray-400 text-sm mt-2",children:"Please allow camera access"})]})}),p&&a.jsx("div",{className:"absolute inset-0 bg-black flex items-center justify-center p-6 z-20",children:a.jsxs("div",{className:"text-center max-w-md",children:[a.jsx(l,{className:"w-20 h-20 text-red-500 mx-auto mb-4"}),a.jsx("h3",{className:"text-2xl font-bold text-white mb-3",children:"Camera Error"}),a.jsx("p",{className:"text-gray-300 mb-6 leading-relaxed",children:p}),a.jsxs("div",{className:"bg-white/10 rounded-xl p-4 mb-6 text-left",children:[a.jsx("p",{className:"text-white font-medium mb-2",children:"ðŸ’¡ Troubleshooting:"}),a.jsxs("ul",{className:"text-gray-300 text-sm space-y-1",children:[a.jsx("li",{children:"â€¢ Check browser camera permissions"}),a.jsx("li",{children:"â€¢ Close other apps using camera"}),a.jsx("li",{children:"â€¢ Try refreshing the page"}),a.jsx("li",{children:"â€¢ Make sure you're on HTTPS"})]})]}),a.jsx("button",{onClick:T,className:"w-full bg-white text-gray-900 px-6 py-3 rounded-xl font-medium hover:bg-gray-100 transition-colors",children:"Close & Try Again"})]})}),a.jsx("style",{children:"\n        @keyframes scan {\n          0% {\n            transform: translateY(-100%);\n          }\n          100% {\n            transform: translateY(400%);\n          }\n        }\n        .animate-scan {\n          animation: scan 2s linear infinite;\n        }\n      "})]}):null},y=()=>{var s;const r=c(),{user:i,authLoading:n}=g(),[l,f]=e.useState(!1),[y,N]=e.useState(!1),_=!n&&!!(null==i?void 0:i.id),{data:C,isLoading:k}=o({queryKey:["recent-inspections",null==i?void 0:i.id],queryFn:async()=>{if(!(null==i?void 0:i.id))throw new Error("User not authenticated");const{data:e,error:t}=await p.from("inspection_records").select("\n          id,\n          inspection_date,\n          inspection_time,\n          overall_status,\n          locations!inner (\n            id,\n            name,\n            building,\n            floor,\n            code\n          )\n        ").eq("user_id",i.id).order("inspection_date",{ascending:!1}).order("inspection_time",{ascending:!1}).limit(5);if(t)throw t;return e},enabled:_,staleTime:3e4}),{data:S}=o({queryKey:["user-stats",null==i?void 0:i.id],queryFn:async()=>{if(!(null==i?void 0:i.id))throw new Error("User not authenticated");const{data:e,error:t}=await p.from("inspection_records").select("id, overall_status, inspection_date").eq("user_id",i.id);if(t)throw t;return{total:e.length,completed:e.filter(e=>"completed"===e.overall_status).length,today:e.filter(e=>{const t=new Date(e.inspection_date||""),a=new Date;return t.toDateString()===a.toDateString()}).length}},enabled:_,staleTime:6e4});return n?a.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),a.jsx("p",{className:"text-gray-600",children:"Loading..."})]})}):a.jsxs("div",{className:"min-h-screen bg-white pb-20",children:[a.jsx(v,{isOpen:y,onClose:()=>N(!1)}),a.jsxs("div",{className:"bg-white p-6 border-b border-gray-100",children:[a.jsx("div",{className:"flex items-center justify-between mb-6",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("button",{onClick:()=>N(!0),className:"w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-md hover:shadow-lg transition-shadow border border-gray-100",children:a.jsx(d,{className:"w-5 h-5 text-gray-600"})}),a.jsxs("div",{children:[a.jsxs("h1",{className:"text-xl font-bold text-gray-900",children:["Hi, ",(null==(s=null==i?void 0:i.email)?void 0:s.split("@")[0])||"Guest","! ðŸ‘‹"]}),a.jsx("p",{className:"text-sm text-gray-500",children:"Ready to scan?"})]})]})}),a.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[a.jsxs("div",{className:"bg-white rounded-2xl p-3 shadow-[0_8px_30px_rgb(0,0,0,0.08)] border border-gray-50 text-center",children:[a.jsx("div",{className:"text-2xl font-bold text-gray-900",children:(null==S?void 0:S.total)||0}),a.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"Total"})]}),a.jsxs("div",{className:"bg-white rounded-2xl p-3 shadow-[0_8px_30px_rgb(0,0,0,0.08)] border border-gray-50 text-center",children:[a.jsx("div",{className:"text-2xl font-bold text-blue-600",children:(null==S?void 0:S.today)||0}),a.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"Today"})]}),a.jsxs("div",{className:"bg-white rounded-2xl p-3 shadow-[0_8px_30px_rgb(0,0,0,0.08)] border border-gray-50 text-center",children:[a.jsxs("div",{className:"text-2xl font-bold text-green-600",children:[S&&Math.round(S.completed/S.total*100)||0,"%"]}),a.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"Success"})]})]})]}),a.jsxs("div",{className:"p-5 space-y-5",children:[a.jsx("button",{onClick:()=>f(!0),className:"w-full bg-white rounded-3xl p-8 shadow-[0_12px_40px_rgb(0,0,0,0.12)] active:shadow-[0_8px_30px_rgb(0,0,0,0.1)] active:translate-y-1 transition-all border border-gray-100",children:a.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[a.jsx("div",{className:"w-20 h-20 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg",children:a.jsx(x,{className:"w-10 h-10 text-white"})}),a.jsxs("div",{className:"text-center",children:[a.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Scan QR Code"}),a.jsx("p",{className:"text-gray-500 text-sm mt-1",children:"Point camera at location QR"})]})]})}),a.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[a.jsxs("button",{onClick:()=>r("/locations"),className:"bg-white rounded-2xl p-5 shadow-[0_8px_30px_rgb(0,0,0,0.08)] active:shadow-[0_4px_20px_rgb(0,0,0,0.06)] active:translate-y-1 transition-all border border-gray-50",children:[a.jsx(m,{className:"w-7 h-7 text-blue-600 mb-3"}),a.jsx("span",{className:"text-sm font-semibold text-gray-900",children:"Locations"})]}),a.jsxs("button",{onClick:()=>r("/dashboard"),className:"bg-white rounded-2xl p-5 shadow-[0_8px_30px_rgb(0,0,0,0.08)] active:shadow-[0_4px_20px_rgb(0,0,0,0.06)] active:translate-y-1 transition-all border border-gray-50",children:[a.jsx(h,{className:"w-7 h-7 text-green-600 mb-3"}),a.jsx("span",{className:"text-sm font-semibold text-gray-900",children:"Dashboard"})]})]}),a.jsxs("div",{className:"bg-white rounded-2xl shadow-[0_8px_30px_rgb(0,0,0,0.08)] border border-gray-50 p-5",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsx("h3",{className:"font-bold text-gray-900",children:"Recent"}),a.jsx("button",{onClick:()=>r("/dashboard"),className:"text-sm text-blue-600 font-medium",children:"View All"})]}),a.jsx("div",{className:"space-y-3",children:k?a.jsx("div",{className:"text-center py-8",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"})}):0===(null==C?void 0:C.length)?a.jsxs("div",{className:"text-center py-8",children:[a.jsx(u,{className:"w-12 h-12 mx-auto mb-2 text-gray-200"}),a.jsx("p",{className:"text-gray-400 text-sm",children:"No inspections yet"})]}):null==C?void 0:C.slice(0,5).map(e=>a.jsx("div",{className:"flex items-center justify-between",children:a.jsxs("div",{className:"flex items-center space-x-3",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl flex items-center justify-center "+("completed"===e.overall_status?"bg-green-50":"bg-gray-50"),children:"completed"===e.overall_status?a.jsx(b,{className:"w-5 h-5 text-green-600"}):a.jsx(u,{className:"w-5 h-5 text-gray-400"})}),a.jsxs("div",{children:[a.jsx("div",{className:"font-medium text-gray-900 text-sm",children:e.locations.name}),a.jsx("div",{className:"text-xs text-gray-500",children:j(new Date(e.inspection_date),"dd MMM")})]})]})},e.id))})]})]}),a.jsx(w,{isOpen:l,onClose:()=>f(!1),onScan:async e=>{try{if(!/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e))return void t.error("Invalid location ID format");const{data:a,error:s}=await p.from("locations").select("id, name, is_active, building, floor").eq("id",e).single();if(s||!a)return void t.error("Location not found. Please contact admin.");if(!a.is_active)return void t.error("This location is currently inactive");t.success(`Opening ${a.name}...`),f(!1),r(`/inspect/${a.id}`)}catch(a){t.error("Failed to process QR code")}}})]})};export{y as ScanPage};
