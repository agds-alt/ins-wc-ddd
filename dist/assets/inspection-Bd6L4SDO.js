import{r as e,I as t,j as a,v as o,w as r,M as n,x as s,X as i,L as l,y as c,u as d,a as m,b as u,f as h,A as g,z as b,n as p,G as x}from"./react-vendor-B_wON18L.js";import{f}from"./date-vendor-DWqTPjCA.js";import{l as y,s as w,u as v}from"./admin-DxXcpQLf.js";import{i as j}from"./vendor-C4HD8sBH.js";const N=[{id:"aroma",category:"aroma",label:"Aroma/Odor Level",labelGenZ:"Bau-bauan",weight:.15,icon:"Nose",iconGenZ:"ğŸ˜·",required:!0,allowPhoto:!1,choices:{professional:{good:"Fresh/Pleasant",normal:"Neutral",bad:"Unpleasant Odor",other:"Other (specify)"},genZ:{good:"ğŸŒ¸ Wangi",normal:"ğŸ˜ Normal",bad:"ğŸ¤¢ Bau",other:"ğŸ’¬ Lainnya"}}},{id:"floor_cleanliness",category:"visual",label:"Floor Cleanliness",labelGenZ:"Kebersihan Lantai",weight:.12,icon:"Droplets",iconGenZ:"âœ¨",required:!0,allowPhoto:!0,choices:{professional:{good:"Clean",normal:"Acceptable",bad:"Dirty",other:"Other (specify)"},genZ:{good:"âœ¨ Bersih",normal:"ğŸ˜ Cukup",bad:"ğŸ’© Kotor",other:"ğŸ’¬ Lainnya"}}},{id:"wall_condition",category:"visual",label:"Wall & Tile Condition",labelGenZ:"Kondisi Dinding",weight:.08,icon:"Square",iconGenZ:"ğŸ¨",required:!0,allowPhoto:!0,choices:{professional:{good:"Clean",normal:"Acceptable",bad:"Dirty/Damaged",other:"Other (specify)"},genZ:{good:"âœ¨ Bersih",normal:"ğŸ˜ Cukup",bad:"ğŸ’© Kotor",other:"ğŸ’¬ Lainnya"}}},{id:"mirror_condition",category:"visual",label:"Mirror Cleanliness",labelGenZ:"Kebersihan Cermin",weight:.06,icon:"Mirror",iconGenZ:"âœ¨",required:!0,allowPhoto:!1,choices:{professional:{good:"Clean",normal:"Acceptable",bad:"Dirty/Spotted",other:"Other (specify)"},genZ:{good:"âœ¨ Bersih",normal:"ğŸ˜ Cukup",bad:"ğŸ’© Kotor",other:"ğŸ’¬ Lainnya"}}},{id:"toilet_condition",category:"visual",label:"Toilet Bowl Condition",labelGenZ:"Kondisi Kloset",weight:.15,icon:"Droplet",iconGenZ:"ğŸš½",required:!0,allowPhoto:!0,choices:{professional:{good:"Clean",normal:"Acceptable",bad:"Dirty",other:"Other (specify)"},genZ:{good:"âœ¨ Bersih",normal:"ğŸ˜ Cukup",bad:"ğŸ’© Kotor",other:"ğŸ’¬ Lainnya"}}},{id:"trash_bin_condition",category:"visual",label:"Trash Bin Condition",labelGenZ:"Kondisi Tempat Sampah",weight:.06,icon:"Trash2",iconGenZ:"ğŸ—‘ï¸",required:!0,allowPhoto:!1,choices:{professional:{good:"Clean/Not Full",normal:"Half Full",bad:"Overflowing",other:"Other (specify)"},genZ:{good:"âœ¨ Bersih",normal:"ğŸ˜ Setengah",bad:"ğŸ˜« Penuh",other:"ğŸ’¬ Lainnya"}}},{id:"sink_condition",category:"functional",label:"Sink & Faucet Condition",labelGenZ:"Kondisi Wastafel",weight:.1,icon:"Droplet",iconGenZ:"ğŸ’§",required:!0,allowPhoto:!0,choices:{professional:{good:"Functioning Properly",normal:"Minor Issues",bad:"Not Functional",other:"Other (specify)"},genZ:{good:"âœ… Normal",normal:"âš ï¸ Agak Bermasalah",bad:"âŒ Rusak",other:"ğŸ’¬ Lainnya"}}},{id:"urinal_condition",category:"functional",label:"Urinal Condition",labelGenZ:"Kondisi Urinoir",weight:.08,icon:"Droplets",iconGenZ:"ğŸš¿",required:!1,allowPhoto:!0,choices:{professional:{good:"Functioning Properly",normal:"Minor Issues",bad:"Not Functional",other:"Other (specify)"},genZ:{good:"âœ… Normal",normal:"âš ï¸ Agak Bermasalah",bad:"âŒ Rusak",other:"ğŸ’¬ Lainnya"}}},{id:"soap_availability",category:"availability",label:"Soap Availability",labelGenZ:"Ketersediaan Sabun",weight:.08,icon:"Droplets",iconGenZ:"ğŸ§´",required:!0,allowPhoto:!1,choices:{professional:{good:"Available",normal:"Low Stock",bad:"Empty",other:"Other (specify)"},genZ:{good:"âœ… Ada",normal:"âš ï¸ Hampir Habis",bad:"âŒ Habis",other:"ğŸ’¬ Lainnya"}}},{id:"tissue_availability",category:"availability",label:"Tissue Availability",labelGenZ:"Ketersediaan Tissue",weight:.08,icon:"FileText",iconGenZ:"ğŸ§»",required:!0,allowPhoto:!1,choices:{professional:{good:"Available",normal:"Low Stock",bad:"Empty",other:"Other (specify)"},genZ:{good:"âœ… Ada",normal:"âš ï¸ Hampir Habis",bad:"âŒ Habis",other:"ğŸ’¬ Lainnya"}}},{id:"air_freshener",category:"availability",label:"Air Freshener",labelGenZ:"Pengharum Ruangan",weight:.04,icon:"Wind",iconGenZ:"ğŸŒ¬ï¸",required:!0,allowPhoto:!1,choices:{professional:{good:"Available",normal:"Low Stock",bad:"Empty",other:"Other (specify)"},genZ:{good:"âœ… Ada",normal:"âš ï¸ Hampir Habis",bad:"âŒ Habis",other:"ğŸ’¬ Lainnya"}}}],k=e=>{let t=0,a=0;return e.forEach(e=>{const o=N.find(t=>t.id===e.component);if(!o)return;t+=o.weight;a+={good:100,normal:60,bad:20,other:40}[e.choice]*o.weight}),0===t?0:Math.round(a/t)},S=e=>e>=85?{label:"Excellent",color:"green",emoji:"ğŸŒŸ"}:e>=70?{label:"Good",color:"blue",emoji:"ğŸ˜Š"}:e>=50?{label:"Fair",color:"yellow",emoji:"ğŸ˜"}:e>=30?{label:"Poor",color:"orange",emoji:"ğŸ˜Ÿ"}:{label:"Critical",color:"red",emoji:"ğŸ˜¨"},_=({config:n,value:s,onChange:i,onPhotoAdd:l,hasPhoto:c,genZMode:d=!1,notes:m,onNotesChange:u})=>{const[h,g]=e.useState("other"===s),b=d?n.choices.genZ:n.choices.professional,p=d?n.labelGenZ:n.label,x=!d&&n.icon?t[n.icon]:null,f=e=>{i(e),"other"===e&&g(!0)};return a.jsxs("div",{className:"bg-white rounded-2xl p-4 shadow-sm border border-gray-100",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsxs("div",{className:"flex items-center space-x-3",children:[a.jsx("div",{className:`\n            w-12 h-12 rounded-xl flex items-center justify-center text-2xl\n            ${d?"bg-gradient-to-br from-purple-100 to-pink-100":"bg-blue-50"}\n          `,children:d?n.iconGenZ:x?a.jsx(x,{className:"w-6 h-6 text-blue-600"}):n.icon}),a.jsxs("div",{children:[a.jsxs("h3",{className:"font-semibold "+(d?"text-purple-900":"text-gray-900"),children:[p,n.required&&a.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),!n.required&&a.jsx("span",{className:"text-xs text-gray-500",children:"Optional"})]})]}),n.allowPhoto&&a.jsx("button",{type:"button",onClick:l,className:`\n              p-2 rounded-xl transition-all\n              ${c?"bg-green-100 text-green-600":d?"bg-purple-100 text-purple-600 hover:bg-purple-200":"bg-gray-100 text-gray-600 hover:bg-gray-200"}\n            `,children:a.jsx(o,{className:"w-5 h-5"})})]}),a.jsx("div",{className:"grid grid-cols-3 gap-2 mb-3",children:["good","normal","bad"].map(e=>{const t=s===e,o=C(e,t,d);return a.jsx("button",{type:"button",onClick:()=>f(e),className:`\n                py-3 px-2 rounded-xl text-center transition-all\n                border-2 font-medium text-sm\n                ${o}\n                ${t?"shadow-md scale-[1.02]":"hover:scale-[1.01]"}\n              `,children:a.jsxs("div",{className:"flex flex-col items-center space-y-1",children:[a.jsx("span",{className:"text-xl",children:P(e,n.category)}),a.jsx("span",{className:"leading-tight",children:b[e]})]})},e)})}),a.jsxs("button",{type:"button",onClick:()=>f("other"),className:`\n          w-full py-3 rounded-xl text-center transition-all\n          border-2 font-medium text-sm flex items-center justify-center space-x-2\n          ${"other"===s?d?"bg-purple-50 border-purple-400 text-purple-700":"bg-blue-50 border-blue-400 text-blue-700":"bg-gray-50 border-gray-200 text-gray-600 hover:border-gray-300"}\n        `,children:[a.jsx(r,{className:"w-4 h-4"}),a.jsx("span",{children:b.other})]}),h&&a.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-100",children:[a.jsx("textarea",{value:m||"",onChange:e=>null==u?void 0:u(e.target.value),placeholder:"other"===s?d?"Jelasin detailnya dong...":"Please specify the details...":d?"Catatan tambahan (opsional)...":"Additional notes (optional)...",className:`\n              w-full px-3 py-2 border rounded-xl focus:ring-2 resize-none\n              ${"other"===s?"border-orange-300 focus:ring-orange-500 focus:border-orange-500":"border-gray-200 focus:ring-blue-500 focus:border-blue-500"}\n            `,rows:3,required:"other"===s}),"other"!==s&&a.jsx("button",{type:"button",onClick:()=>g(!1),className:"text-sm text-gray-500 hover:text-gray-700 mt-1",children:"Ã— Hide notes"})]}),s&&"other"!==s&&!h&&a.jsx("button",{type:"button",onClick:()=>g(!0),className:`\n            w-full mt-3 py-2 text-sm font-medium rounded-xl\n            ${d?"text-purple-600 hover:bg-purple-50":"text-blue-600 hover:bg-blue-50"}\n          `,children:"+ Add notes"})]})},C=(e,t,a)=>{if(!t)return"bg-white border-gray-200 text-gray-700 hover:border-gray-300 hover:bg-gray-50";if(a)switch(e){case"good":return"bg-gradient-to-br from-green-50 to-emerald-50 border-green-400 text-green-900";case"normal":return"bg-gradient-to-br from-yellow-50 to-amber-50 border-yellow-400 text-yellow-900";case"bad":return"bg-gradient-to-br from-red-50 to-pink-50 border-red-400 text-red-900";default:return"bg-white border-gray-200 text-gray-700"}else switch(e){case"good":return"bg-green-50 border-green-500 text-green-900";case"normal":return"bg-yellow-50 border-yellow-500 text-yellow-900";case"bad":return"bg-red-50 border-red-500 text-red-900";default:return"bg-white border-gray-200 text-gray-700"}},P=(e,t)=>{if("aroma"===t)switch(e){case"good":return"ğŸŒ¸";case"normal":return"ğŸ˜";case"bad":return"ğŸ¤¢"}if("visual"===t)switch(e){case"good":return"âœ¨";case"normal":return"ğŸ˜";case"bad":return"ğŸ’©"}if("availability"===t)switch(e){case"good":return"âœ…";case"normal":return"âš ï¸";case"bad":return"âŒ"}if("functional"===t)switch(e){case"good":return"âœ…";case"normal":return"âš ï¸";case"bad":return"âŒ"}return"ğŸ’¬"},F=({photos:t,onPhotosChange:r,maxPhotos:c=3,genZMode:d=!1})=>{const m=e.useRef(null),[u,h]=e.useState(!1),g=t.length<c;return a.jsxs("div",{className:"space-y-3",children:[t.length>0&&a.jsx("div",{className:"grid grid-cols-2 gap-3",children:t.map((e,o)=>a.jsxs("div",{className:"relative group",children:[a.jsx("img",{src:e.preview,alt:`Photo ${o+1}`,className:"w-full h-32 object-cover rounded-xl border-2 border-gray-200"}),a.jsxs("div",{className:"absolute bottom-2 left-2 right-2 flex items-center justify-between",children:[e.location&&a.jsxs("div",{className:"bg-black/70 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-lg flex items-center space-x-1",children:[a.jsx(n,{className:"w-3 h-3"}),a.jsx("span",{children:"GPS"})]}),a.jsxs("div",{className:"bg-black/70 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-lg flex items-center space-x-1",children:[a.jsx(s,{className:"w-3 h-3"}),a.jsx("span",{children:f(new Date(e.timestamp),"HH:mm")})]})]}),a.jsx("button",{type:"button",onClick:()=>(e=>{const a=t.filter((t,a)=>a!==e);r(a)})(o),className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity shadow-lg",children:a.jsx(i,{className:"w-4 h-4"})})]},o))}),g&&a.jsx("button",{type:"button",onClick:()=>{var e;return null==(e=m.current)?void 0:e.click()},disabled:u,className:`\n            w-full h-24 border-2 border-dashed rounded-xl \n            flex flex-col items-center justify-center\n            transition-all\n            ${u?"bg-gray-100 border-gray-300 cursor-not-allowed":d?"border-purple-300 hover:border-purple-500 hover:bg-purple-50":"border-gray-300 hover:border-blue-500 hover:bg-blue-50"}\n          `,children:u?a.jsxs(a.Fragment,{children:[a.jsx(l,{className:"w-8 h-8 text-gray-400 animate-spin mb-2"}),a.jsx("span",{className:"text-sm text-gray-500",children:"Processing..."})]}):a.jsxs(a.Fragment,{children:[a.jsx(o,{className:"w-8 h-8 mb-2 "+(d?"text-purple-500":"text-gray-400")}),a.jsx("span",{className:"text-sm font-medium "+(d?"text-purple-600":"text-gray-600"),children:d?"ğŸ“¸ Foto yuk!":"Take Photo"}),a.jsxs("span",{className:"text-xs text-gray-400 mt-1",children:[t.length,"/",c," photos"]})]})}),a.jsx("input",{ref:m,type:"file",accept:"image/*",capture:"environment",onChange:async e=>{var a;const o=null==(a=e.target.files)?void 0:a[0];if(o){h(!0);try{const e=await $();let a;e&&A(e.lat,e.lng).then(e=>{a=e}).catch(()=>{});const n={file:o,preview:await Z(o,{timestamp:(new Date).toISOString(),location:e?{...e,address:a}:void 0}),timestamp:(new Date).toISOString(),location:e?{...e,address:a}:void 0};r([...t,n])}catch(n){const e=URL.createObjectURL(o);r([...t,{file:o,preview:e,timestamp:(new Date).toISOString()}])}finally{h(!1),m.current&&(m.current.value="")}}},className:"hidden"})]})},$=()=>new Promise(e=>{"geolocation"in navigator?navigator.geolocation.getCurrentPosition(t=>{e({lat:t.coords.latitude,lng:t.coords.longitude})},()=>e(null),{timeout:5e3}):e(null)}),A=async(e,t)=>{try{const a=new AbortController,o=setTimeout(()=>a.abort(),3e3),r=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${e}&lon=${t}&format=json`,{headers:{"User-Agent":"ToiletCheck/1.0"},signal:a.signal});if(clearTimeout(o),!r.ok)return;return(await r.json()).display_name}catch(a){return void a.name}},Z=async(e,t)=>new Promise(a=>{const o=new Image,r=new FileReader;r.onload=e=>{var t;o.src=null==(t=e.target)?void 0:t.result},o.onload=()=>{const r=document.createElement("canvas");r.width=o.width,r.height=o.height;const n=r.getContext("2d");if(!n)return void a(URL.createObjectURL(e));n.drawImage(o,0,0);n.fillStyle="rgba(0, 0, 0, 0.6)",n.fillRect(0,r.height-60,r.width,60),n.fillStyle="white",n.font="bold 16px Arial";const s=f(new Date(t.timestamp),"dd/MM/yyyy HH:mm:ss");n.fillText(s,10,r.height-35),t.location&&(n.font="14px Arial",n.fillText(`ğŸ“ ${t.location.lat.toFixed(5)}, ${t.location.lng.toFixed(5)}`,10,r.height-10)),a(r.toDataURL("image/jpeg",.9))},r.readAsDataURL(e)}),D=({photos:t,onPhotosChange:r,maxPhotos:d=5,genZMode:m=!1,locationName:u})=>{const h=e.useRef(null),[g,b]=e.useState(!1),[p,x]=e.useState(null),y=t.length<d;return a.jsxs("div",{className:"space-y-3",children:[t.length>0&&a.jsx("div",{className:"grid grid-cols-2 gap-3",children:t.map((e,o)=>a.jsxs("div",{className:"relative group",children:[a.jsx("img",{src:e.preview,alt:`Photo ${o+1}`,className:"w-full aspect-[4/3] object-cover rounded-xl border-2 border-gray-200"}),a.jsxs("div",{className:"absolute bottom-2 left-2 right-2 flex items-center justify-between gap-1",children:[e.geolocation&&a.jsxs("div",{className:"bg-black/70 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-lg flex items-center space-x-1",children:[a.jsx(n,{className:"w-3 h-3"}),a.jsx("span",{children:"GPS"})]}),a.jsxs("div",{className:"bg-black/70 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-lg flex items-center space-x-1",children:[a.jsx(s,{className:"w-3 h-3"}),a.jsx("span",{children:f(new Date(e.timestamp),"HH:mm")})]})]}),a.jsx("button",{type:"button",onClick:()=>(e=>{const a=t.filter((t,a)=>a!==e);r(a)})(o),className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1.5 opacity-0 group-hover:opacity-100 transition-opacity shadow-lg",children:a.jsx(i,{className:"w-4 h-4"})})]},o))}),p&&a.jsxs("div",{className:"bg-orange-50 border border-orange-200 rounded-xl p-3 flex items-start space-x-2",children:[a.jsx(c,{className:"w-5 h-5 text-orange-600 flex-shrink-0 mt-0.5"}),a.jsx("p",{className:"text-sm text-orange-800",children:p})]}),y&&a.jsx("button",{type:"button",onClick:()=>{var e;return null==(e=h.current)?void 0:e.click()},disabled:g,className:`\n            w-full py-6 border-2 border-dashed rounded-xl \n            flex flex-col items-center justify-center space-y-2\n            transition-all\n            ${g?"bg-gray-50 border-gray-300 cursor-wait":m?"border-purple-300 bg-purple-50 hover:border-purple-400 hover:bg-purple-100 text-purple-700":"border-blue-300 bg-blue-50 hover:border-blue-400 hover:bg-blue-100 text-blue-700"}\n          `,children:g?a.jsxs(a.Fragment,{children:[a.jsx(l,{className:"w-8 h-8 animate-spin"}),a.jsx("span",{className:"text-sm font-medium",children:m?"Processing foto...":"Processing photo..."})]}):a.jsxs(a.Fragment,{children:[a.jsx(o,{className:"w-8 h-8"}),a.jsxs("div",{className:"text-center",children:[a.jsx("p",{className:"font-medium",children:m?"ğŸ“¸ Ambil Foto":"ğŸ“¸ Take Photo"}),a.jsxs("p",{className:"text-xs opacity-75 mt-1",children:[t.length,"/",d," photos â€¢ Auto watermark"]})]})]})}),a.jsx("input",{ref:h,type:"file",accept:"image/*",capture:"environment",onChange:async e=>{var a;const o=null==(a=e.target.files)?void 0:a[0];if(o){b(!0),x(null);try{if(!(await(async()=>{try{return(await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})).getTracks().forEach(e=>e.stop()),await new Promise((e,t)=>{navigator.geolocation.getCurrentPosition(e,t,{enableHighAccuracy:!0,timeout:1e4})}),!0}catch(e){return x(m?"Butuh akses kamera & lokasi untuk watermark otomatis. Cek pengaturan browser kamu.":"Camera & location access required for auto-watermark. Check your browser settings."),!1}})()))return void b(!1);const e=await T();let a;e&&L(e.lat,e.lng).then(e=>{a=e}).catch(()=>{});const n=await I(o,{timestamp:(new Date).toISOString(),location:e?{...e,address:a}:void 0,locationName:u}),s=URL.createObjectURL(n),i={file:new File([n],o.name,{type:"image/jpeg"}),preview:s,timestamp:(new Date).toISOString(),geolocation:e};r([...t,i]),"vibrate"in navigator&&navigator.vibrate(100)}catch(n){const e=URL.createObjectURL(o);r([...t,{file:o,preview:e,timestamp:(new Date).toISOString()}]),x(m?"Foto berhasil ditambah tapi tanpa watermark (permission ditolak)":"Photo added without watermark (permission denied)")}finally{b(!1),h.current&&(h.current.value="")}}},className:"hidden"}),y&&a.jsx("p",{className:"text-xs text-gray-500 text-center",children:m?"âœ¨ Watermark otomatis: Tanggal, Jam, Lokasi GPS & Nama Toilet":"âœ¨ Auto watermark: Date, Time, GPS Location & Toilet Name"})]})},T=()=>new Promise(e=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(t=>{e({lat:t.coords.latitude,lng:t.coords.longitude})},t=>{e(null)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0}):e(null)}),L=async(e,t)=>{try{const a=new AbortController,o=setTimeout(()=>a.abort(),3e3),r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${t}&zoom=18`,{headers:{"User-Agent":"ToiletCheck/1.0"},signal:a.signal});if(clearTimeout(o),!r.ok)return;const n=(await r.json()).address;return[n.road,n.suburb||n.neighbourhood,n.city||n.county].filter(Boolean).slice(0,2).join(", ")}catch(a){return void a.name}},I=async(e,t)=>new Promise((a,o)=>{const r=new FileReader;r.onload=e=>{var r;const n=new Image;n.src=null==(r=e.target)?void 0:r.result,n.onload=()=>{var e;const r=document.createElement("canvas");r.width=n.width,r.height=n.height;const s=r.getContext("2d");s.drawImage(n,0,0);const i=Math.max(20,.025*n.width),l=Math.max(20,.03*n.width),c=f(new Date(t.timestamp),"dd/MM/yyyy"),d=f(new Date(t.timestamp),"HH:mm:ss"),m=[`ğŸ“ ${t.locationName}`,`ğŸ“… ${c} â° ${d}`];(null==(e=t.location)?void 0:e.address)?m.push(`ğŸ—ºï¸ ${t.location.address}`):t.location&&m.push(`ğŸ§­ ${t.location.lat.toFixed(6)}, ${t.location.lng.toFixed(6)}`),s.font=`bold ${l}px Arial, sans-serif`;const u=Math.max(...m.map(e=>s.measureText(e).width)),h=1.4*l,g=m.length*h+2*i;s.fillStyle="rgba(0, 0, 0, 0.85)",s.fillRect(i,n.height-g-i,u+3*i,g),s.fillStyle="#FFFFFF",s.font=`bold ${l}px Arial, sans-serif`,m.forEach((e,t)=>{s.fillText(e,2*i,n.height-g-i+h*(t+1))}),s.font=`bold ${.9*l}px Arial, sans-serif`,s.fillStyle="rgba(255, 255, 255, 0.7)";const b="TOILET CHECK âœ“",p=s.measureText(b).width;s.fillStyle="rgba(0, 0, 0, 0.6)",s.fillRect(n.width-p-3*i,i,p+2*i,1.8*l),s.fillStyle="rgba(255, 255, 255, 0.95)",s.fillText(b,n.width-p-2*i,i+1.2*l),r.toBlob(e=>{e?a(e):o(new Error("Failed to create watermarked photo"))},"image/jpeg",.92)},n.onerror=()=>o(new Error("Failed to load image"))},r.onerror=()=>o(new Error("Failed to read file")),r.readAsDataURL(e)}),q=async e=>{const t={maxSizeMB:.5,maxWidthOrHeight:1920,useWebWorker:!0,fileType:"image/webp"};try{return await j(e,t)}catch(a){return e}},M=async e=>{var t;const a=new FormData;a.append("file",e),a.append("upload_preset","toilet-checks"),a.append("cloud_name","dcg56qkae"),a.append("folder","toilet-inspections");try{const e=await fetch("https://api.cloudinary.com/v1_1/dcg56qkae/image/upload",{method:"POST",body:a}),o=await e.json();if(!e.ok)throw new Error((null==(t=o.error)?void 0:t.message)||"Upload failed");return o.secure_url}catch(o){throw new Error("Failed to upload photo")}},G=({locationId:t})=>{const r=!0,n=h(),{user:s,profile:i}=v(),{getLocation:l,submitInspection:x}=(e=>{const t=d(),a=m({queryKey:["inspection",e],queryFn:async()=>null,enabled:!1}),o=m({queryKey:["default-template"],queryFn:async()=>{const{data:e,error:t}=await w.from("inspection_templates").select("*").eq("is_default",!0).eq("is_active",!0).single();return t?(y.warn("Using fallback template",t),{id:"comprehensive-template",name:"Comprehensive Inspection",description:"Default comprehensive inspection template",fields:{components:[],requiredPhotos:0,maxPhotos:10,allowNotes:!0},estimated_time:300,is_active:!0,is_default:!0,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}):e},retry:1}),r=u({mutationFn:async e=>{var t;const a=y.startTimer("Submit inspection"),{location_id:r,user_id:n,responses:s,photo_urls:i,notes:l,duration_seconds:c}=e;if(!r||!n)throw new Error("Location ID and User ID are required");y.info("Submitting inspection with photos",{photo_count:i.length});let d="comprehensive-template";try{const e=await o.refetch();(null==(t=e.data)?void 0:t.id)&&(d=e.data.id)}catch(j){y.warn("Using fallback template ID")}const m=new Date,u=m.toISOString().split("T")[0],h=m.toTimeString().split(" ")[0],g=m.toISOString(),b=s.score||0;let p="satisfactory";p=b>=90?"excellent":b>=75?"good":b>=60?"fair":b>=40?"poor":"very_poor";const x={location_id:r,user_id:n,template_id:d,inspection_date:u,inspection_time:h,overall_status:p,responses:s,photo_urls:i.length>0?i:null,notes:(null==l?void 0:l.trim())||null,submitted_at:g,duration_seconds:c||null,verification_notes:null,verified_at:null,verified_by:null};y.info("Saving inspection to database",{location_id:r,photos:i.length,score:b});const{data:f,error:v}=await w.from("inspection_records").insert(x).select("id, location_id, overall_status, submitted_at").single();if(v)throw a(),y.error("Failed to submit inspection",v),new Error(`Failed to submit inspection: ${v.message}`);return a(),y.info("Inspection submitted successfully",{id:f.id}),f},onSuccess:()=>{t.invalidateQueries({queryKey:["inspections"]}),t.invalidateQueries({queryKey:["location-inspections"]})},onError:e=>{y.error("Inspection mutation failed",e)}});return{getInspection:a,getDefaultTemplate:o,getLocation:e=>m({queryKey:["location",e],queryFn:async()=>{if(!e)throw new Error("Location ID is required");const{data:t,error:a}=await w.from("locations_with_details").select("*").eq("id",e).single();if(a)throw y.error("Failed to fetch location",a),new Error(`Failed to fetch location: ${a.message}`);return t},enabled:!!e}),submitInspection:r,getLocationInspections:e=>m({queryKey:["location-inspections",e],queryFn:async()=>{if(!e)return[];const{data:t,error:a}=await w.from("inspection_records").select("\n          *,\n          users:user_id (\n            full_name,\n            email\n          )\n        ").eq("location_id",e).order("submitted_at",{ascending:!1});if(a)throw y.error("Failed to fetch location inspections",a),new Error(`Failed to fetch inspections: ${a.message}`);return t},enabled:!!e})}})(),[f,j]=e.useState(new Map),[S,C]=e.useState(new Map),[P,$]=e.useState([]),[A,Z]=e.useState(""),[T,L]=e.useState(!1),[I,G]=e.useState(""),[O,U]=e.useState(!1),[H,E]=e.useState(null),[K,R]=e.useState("low"),[B,z]=e.useState(!1),[W]=e.useState(new Date),[J,Q]=e.useState(0),[V,X]=e.useState(N[0].id),{data:Y,isLoading:ee}=l(t);e.useEffect(()=>{const e=Array.from(f.values());if(e.length>0){const t=k(e);Q(t)}},[f]);if(ee)return a.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:a.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})});if(!Y)return a.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center p-4",children:a.jsxs("div",{className:"text-center",children:[a.jsx(c,{className:"w-12 h-12 text-red-500 mx-auto mb-2"}),a.jsx("p",{className:"text-gray-700",children:"Location not found"})]})});const te=f.size,ae=N.filter(e=>e.required).length,oe=te/N.length*100;return a.jsxs("div",{className:"min-h-screen pb-32 bg-gradient-to-br from-blue-50 via-cyan-50 to-indigo-50",children:[a.jsx("div",{className:"\n        sticky top-0 z-20\n        bg-gradient-to-r from-blue-600 to-cyan-600\n        shadow-sm\n      ",children:a.jsxs("div",{className:"p-4",children:[a.jsx("div",{className:"flex items-center justify-between mb-3",children:a.jsx("button",{onClick:()=>n(-1),className:"p-2 rounded-xl bg-white/20 text-white",children:a.jsx(g,{className:"w-5 h-5"})})}),a.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[a.jsx("div",{className:"\n              w-12 h-12 rounded-xl flex items-center justify-center text-2xl\n              bg-white/20\n            ",children:"ğŸš½"}),a.jsxs("div",{className:"text-white",children:[a.jsx("h1",{className:"font-bold text-lg",children:Y.name}),a.jsxs("p",{className:"text-sm text-white/80",children:[Y.building," â€¢ ",Y.floor," â€¢ ",Y.area]})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex items-center justify-between text-sm",children:[a.jsx("span",{className:"text-white/90",children:`Progress ${te}/${N.length}`}),J>0&&a.jsxs("span",{className:"font-bold text-white",children:["Score: ",J]})]}),a.jsx("div",{className:"w-full h-2 bg-white/20 rounded-full overflow-hidden",children:a.jsx("div",{className:"h-full transition-all duration-300 bg-white",style:{width:`${oe}%`}})})]})]})}),a.jsxs("div",{className:"p-4 space-y-4",children:[N.map(e=>{const t=f.get(e.id),o=S.get(e.id)||[],n=V===e.id;return a.jsxs("div",{children:[n?a.jsx(_,{config:e,value:(null==t?void 0:t.choice)||null,onChange:t=>((e,t)=>{const a=f.get(e)||{component:e,choice:"good"};j(new Map(f.set(e,{...a,choice:t})));const o=N.findIndex(t=>t.id===e);if(o<N.length-1){const e=N[o+1];f.has(e.id)||X(e.id)}else X(null)})(e.id,t),onPhotoAdd:e.allowPhoto?()=>{}:void 0,hasPhoto:o.length>0,genZMode:r,notes:null==t?void 0:t.notes,onNotesChange:t=>((e,t)=>{const a=f.get(e);a&&j(new Map(f.set(e,{...a,notes:t})))})(e.id,t)}):a.jsxs("button",{type:"button",onClick:()=>X(e.id),className:`\n                    w-full p-4 rounded-2xl flex items-center justify-between\n                    transition-all border-2\n                    ${t?"bg-gradient-to-r from-green-50 to-emerald-50 border-green-400":"bg-white/80 border-blue-200 hover:border-blue-400"}\n                  `,children:[a.jsxs("div",{className:"flex items-center space-x-3",children:[a.jsx("span",{className:"text-2xl",children:e.iconGenZ}),a.jsx("span",{className:"font-medium text-gray-900",children:e.labelGenZ})]}),t?a.jsx(b,{className:"w-5 h-5 text-green-600"}):e.required?a.jsx("span",{className:"text-red-500",children:"*"}):null]}),n&&e.allowPhoto&&a.jsx("div",{className:"mt-3",children:a.jsx(F,{componentId:e.id,photos:o,onPhotosChange:t=>{return a=e.id,o=t,void C(new Map(S.set(a,o)));var a,o},genZMode:r})}),n&&a.jsx("button",{type:"button",onClick:()=>X(null),className:"\n                    w-full mt-2 py-2 rounded-xl text-sm font-medium\n                    bg-blue-100 text-blue-700 hover:bg-blue-200\n                  ",children:"â†‘ Minimize"})]},e.id)}),te>=ae&&a.jsxs("div",{className:"bg-gradient-to-br from-blue-100 to-cyan-100 rounded-2xl p-4 shadow-sm border-2 border-blue-400",children:[a.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[a.jsx(o,{className:"w-5 h-5 text-blue-700"}),a.jsxs("h3",{className:"font-bold text-gray-900",children:["ğŸ“¸ Foto Dokumentasi",a.jsx("span",{className:"text-red-500 ml-1",children:"*"})]})]}),a.jsx("p",{className:"text-sm mb-4 text-blue-900",children:"âš ï¸ WAJIB minimal 1 foto! Auto watermark: Tanggal, Jam, GPS, Nama Toilet."}),a.jsx(D,{photos:P,onPhotosChange:$,maxPhotos:5,genZMode:r,locationName:`${Y.name} - ${Y.building}`})]}),a.jsxs("div",{className:"bg-white/80 rounded-2xl p-4 shadow-sm border border-gray-100",children:[a.jsxs("label",{className:"flex items-center justify-between mb-3",children:[a.jsx("span",{className:"font-semibold text-gray-900",children:"âš ï¸ Ada masalah yang ditemukan?"}),a.jsx("input",{type:"checkbox",checked:T,onChange:e=>L(e.target.checked),className:"w-5 h-5 text-blue-600 rounded focus:ring-blue-500"})]}),T&&a.jsx("textarea",{value:I,onChange:e=>G(e.target.value),placeholder:"Jelasin masalahnya...",className:"w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 resize-none",rows:3})]}),a.jsxs("div",{className:"bg-white/80 rounded-2xl p-4 shadow-sm border border-gray-100",children:[a.jsxs("label",{className:"flex items-center justify-between mb-3",children:[a.jsx("span",{className:"font-semibold text-gray-900",children:"ğŸ”§ Perlu maintenance?"}),a.jsx("input",{type:"checkbox",checked:O,onChange:e=>U(e.target.checked),className:"w-5 h-5 text-blue-600 rounded focus:ring-blue-500"})]}),O&&a.jsx("div",{className:"grid grid-cols-2 gap-2",children:["low","medium","high","urgent"].map(e=>a.jsx("button",{type:"button",onClick:()=>R(e),className:`\n                    py-2 px-3 rounded-xl text-sm font-medium capitalize\n                    ${K===e?"urgent"===e?"bg-red-100 text-red-700 border-2 border-red-500":"high"===e?"bg-orange-100 text-orange-700 border-2 border-orange-500":"medium"===e?"bg-yellow-100 text-yellow-700 border-2 border-yellow-500":"bg-blue-100 text-blue-700 border-2 border-blue-500":"bg-gray-100 text-gray-700 border-2 border-gray-200"}\n                  `,children:e},e))})]}),a.jsxs("div",{className:"bg-white/80 rounded-2xl p-4 shadow-sm border border-gray-100",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ğŸ“ Catatan tambahan (opsional)"}),a.jsx("textarea",{value:A,onChange:e=>Z(e.target.value),placeholder:"Ada yang mau ditambahin?",className:"w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 resize-none",rows:3})]})]}),H&&a.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4",children:a.jsxs("div",{className:"bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl",children:[a.jsxs("div",{className:"text-center mb-4",children:[a.jsx("div",{className:"w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3",children:a.jsxs("svg",{className:"w-8 h-8 text-blue-600 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[a.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),a.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}),a.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-1",children:"Upload Foto..."}),a.jsxs("p",{className:"text-sm text-gray-600",children:[H.current," of ",H.total," photos"]})]}),a.jsxs("div",{className:"relative",children:[a.jsx("div",{className:"h-3 bg-gray-200 rounded-full overflow-hidden",children:a.jsx("div",{className:"h-full bg-gradient-to-r from-blue-500 to-blue-600 transition-all duration-300 ease-out",style:{width:`${H.percentage}%`}})}),a.jsx("div",{className:"mt-2 text-center",children:a.jsxs("span",{className:"text-2xl font-bold text-blue-600",children:[H.percentage,"%"]})})]}),a.jsx("p",{className:"text-xs text-gray-500 text-center mt-4",children:"Sabar ya, lagi upload..."})]})}),H&&a.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"}),a.jsxs("div",{className:"fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200 shadow-lg",children:[a.jsx("button",{type:"button",onClick:async()=>{var e;if(s){if((()=>{const e=N.filter(e=>e.required).filter(e=>!f.has(e.id));if(e.length>0){const t=e.map(e=>e.label).join(", ");return p.error(`Masih ada yang belum diisi: ${t}`),X(e[0].id),!1}const t=Array.from(f.values()).filter(e=>{var t;return"other"===e.choice&&!(null==(t=e.notes)?void 0:t.trim())});if(t.length>0){const e=N.find(e=>e.id===t[0].component);return p.error(`"${null==e?void 0:e.labelGenZ}" pilih "Lainnya" tapi belum dikasih penjelasan!`),X(t[0].component),!1}return 0===P.length?(p.error("ğŸ“¸ Wajib upload minimal 1 foto dokumentasi!"),!1):T&&!I.trim()?(p.error("Tolong jelasin masalah yang ditemukan!"),!1):!(O&&!K&&(p.error("Pilih prioritas maintenance dong!"),1))})()){z(!0);try{const a=new Date,o=Math.floor((a.getTime()-W.getTime())/1e3),r=[];for(const[e,t]of S.entries())for(const a of t)r.push(a.file);const l=P.map(e=>e.file),c=[...r,...l],d=c.length;if(0===d)return void p.error("ğŸ“¸ Wajib upload minimal 1 foto!");const m=p.loading(`ğŸ—œï¸ Kompres ${d} foto...`);E({current:0,total:d,percentage:0});const u=[];for(let e=0;e<c.length;e++){const t=await q(c[e]);u.push(t);const a=Math.round((e+1)/d*50);E({current:e+1,total:d,percentage:a})}p.loading(`â˜ï¸ Upload ${d} foto...`,{id:m});const h=await(async(e,t)=>{const a=[];let o=0;for(let r=0;r<e.length;r+=3){const n=e.slice(r,r+3),s=await Promise.all(n.map(e=>M(e)));a.push(...s),o+=n.length,t&&t(o,e.length)}return a})(u,(e,t)=>{const a=50+Math.round(e/t*50);E({current:e,total:t,percentage:a}),p.loading(`â˜ï¸ Upload ${e}/${t} foto...`,{id:m})});p.loading("ğŸ’¾ Nyimpen inspection...",{id:m}),E(null);const g=new Map(f);let b=0;for(const[e,t]of S.entries()){const a=g.get(e);a&&t.length>0&&(a.photo=h[b],g.set(e,a),b+=t.length)}const y={ratings:Array.from(g.values()),score:J,issues_found:T,issue_description:T?I.trim():null,requires_maintenance:O,maintenance_priority:O?K:null,inspection_mode:"genz",submitted_at:(new Date).toISOString(),inspector:{id:s.id,name:(null==i?void 0:i.full_name)||(null==(e=s.email)?void 0:e.split("@")[0])||"Unknown",email:s.email,profile_id:null==i?void 0:i.id}};await x.mutateAsync({location_id:t,user_id:s.id,responses:y,photo_urls:h,notes:A.trim()||void 0,duration_seconds:o}),p.success(`ğŸ‰ Sukses! Score: ${J}`,{id:m,duration:2e3}),setTimeout(()=>{n("/",{replace:!0})},1500)}catch(a){E(null),p.error("ğŸ˜¢ Gagal submit, coba lagi!")}finally{z(!1),E(null)}}}else p.error("Please login first")},disabled:B||te<ae||0===P.length,className:`\n            w-full py-4 rounded-xl font-bold text-white transition-all\n            ${B||te<ae||0===P.length?"bg-gray-300 cursor-not-allowed":"bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700"}\n          `,children:B?H.total>0?`ğŸ“¸ Upload ${H.current}/${H.total}...`:"â³ Submitting...":`ğŸš€ Submit (Score: ${J})`}),(te<ae||0===P.length)&&a.jsxs("div",{className:"text-center text-sm text-red-600 mt-2 space-y-1",children:[te<ae&&a.jsx("p",{children:`âŒ Masih kurang ${ae-te} komponen wajib`}),0===P.length&&a.jsx("p",{children:"ğŸ“¸ Wajib upload minimal 1 foto dokumentasi"})]})]})]})},O=Object.freeze(Object.defineProperty({__proto__:null,InspectionPage:()=>{const{locationId:e}=x();return e?a.jsx(G,{locationId:e}):a.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center p-4",children:a.jsxs("div",{className:"text-center",children:[a.jsx(c,{className:"w-12 h-12 text-red-500 mx-auto mb-3"}),a.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"Invalid Location"}),a.jsx("p",{className:"text-gray-600",children:"No location ID provided in URL"})]})})}},Symbol.toStringTag,{value:"Module"}));export{N as I,O as a,k as c,S as g};
