import{u as e,r as s,h as t,j as a,m as r,Q as i,M as n,x as l,K as d,V as o,n as c}from"./react-vendor-B7zQ2Eq0.js";import{u as x,S as m,c as h,s as b}from"./admin-DR-prBnq.js";import{f as u}from"./date-vendor-CSGrVI8S.js";import"./vendor-CnJW_4UD.js";import"./supabase-vendor-Cq9hqQQH.js";const g=()=>{var g;const p=e(),{user:j,authLoading:v}=x(),[y,f]=s.useState(!1),[N,w]=s.useState(!1),_=!v&&!!(null==j?void 0:j.id),{data:C,isLoading:S}=t({queryKey:["recent-inspections",null==j?void 0:j.id],queryFn:async()=>{if(!(null==j?void 0:j.id))throw new Error("User not authenticated");const{data:e,error:s}=await b.from("inspection_records").select("\n          id,\n          inspection_date,\n          inspection_time,\n          overall_status,\n          locations!inner (\n            id,\n            name,\n            building,\n            floor,\n            code\n          )\n        ").eq("user_id",j.id).order("inspection_date",{ascending:!1}).order("inspection_time",{ascending:!1}).limit(5);if(s)throw s;return e},enabled:_,staleTime:3e4}),{data:q}=t({queryKey:["user-stats",null==j?void 0:j.id],queryFn:async()=>{if(!(null==j?void 0:j.id))throw new Error("User not authenticated");const{data:e,error:s}=await b.from("inspection_records").select("id, overall_status, inspection_date").eq("user_id",j.id);if(s)throw s;return{total:e.length,completed:e.filter(e=>"completed"===e.overall_status).length,today:e.filter(e=>{const s=new Date(e.inspection_date||""),t=new Date;return s.toDateString()===t.toDateString()}).length}},enabled:_,staleTime:6e4});return v?a.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),a.jsx("p",{className:"text-gray-600",children:"Loading..."})]})}):a.jsxs("div",{className:"min-h-screen bg-white pb-20",children:[a.jsx(m,{isOpen:N,onClose:()=>w(!1)}),a.jsxs("div",{className:"bg-white p-6 border-b border-gray-100",children:[a.jsx("div",{className:"flex items-center justify-between mb-6",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("button",{onClick:()=>w(!0),className:"w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-md hover:shadow-lg transition-shadow border border-gray-100",children:a.jsx(r,{className:"w-5 h-5 text-gray-600"})}),a.jsxs("div",{children:[a.jsxs("h1",{className:"text-xl font-bold text-gray-900",children:["Hi, ",(null==(g=null==j?void 0:j.email)?void 0:g.split("@")[0])||"Guest","! ðŸ‘‹"]}),a.jsx("p",{className:"text-sm text-gray-500",children:"Ready to scan?"})]})]})}),a.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[a.jsxs("div",{className:"bg-white rounded-2xl p-3 shadow-[0_8px_30px_rgb(0,0,0,0.08)] border border-gray-50 text-center",children:[a.jsx("div",{className:"text-2xl font-bold text-gray-900",children:(null==q?void 0:q.total)||0}),a.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"Total"})]}),a.jsxs("div",{className:"bg-white rounded-2xl p-3 shadow-[0_8px_30px_rgb(0,0,0,0.08)] border border-gray-50 text-center",children:[a.jsx("div",{className:"text-2xl font-bold text-blue-600",children:(null==q?void 0:q.today)||0}),a.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"Today"})]}),a.jsxs("div",{className:"bg-white rounded-2xl p-3 shadow-[0_8px_30px_rgb(0,0,0,0.08)] border border-gray-50 text-center",children:[a.jsxs("div",{className:"text-2xl font-bold text-green-600",children:[q&&Math.round(q.completed/q.total*100)||0,"%"]}),a.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"Success"})]})]})]}),a.jsxs("div",{className:"p-5 space-y-5",children:[a.jsx("button",{onClick:()=>f(!0),className:"w-full bg-white rounded-3xl p-8 shadow-[0_12px_40px_rgb(0,0,0,0.12)] active:shadow-[0_8px_30px_rgb(0,0,0,0.1)] active:translate-y-1 transition-all border border-gray-100",children:a.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[a.jsx("div",{className:"w-20 h-20 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg",children:a.jsx(i,{className:"w-10 h-10 text-white"})}),a.jsxs("div",{className:"text-center",children:[a.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Scan QR Code"}),a.jsx("p",{className:"text-gray-500 text-sm mt-1",children:"Point camera at location QR"})]})]})}),a.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[a.jsxs("button",{onClick:()=>p("/locations"),className:"bg-white rounded-2xl p-5 shadow-[0_8px_30px_rgb(0,0,0,0.08)] active:shadow-[0_4px_20px_rgb(0,0,0,0.06)] active:translate-y-1 transition-all border border-gray-50",children:[a.jsx(n,{className:"w-7 h-7 text-blue-600 mb-3"}),a.jsx("span",{className:"text-sm font-semibold text-gray-900",children:"Locations"})]}),a.jsxs("button",{onClick:()=>p("/dashboard"),className:"bg-white rounded-2xl p-5 shadow-[0_8px_30px_rgb(0,0,0,0.08)] active:shadow-[0_4px_20px_rgb(0,0,0,0.06)] active:translate-y-1 transition-all border border-gray-50",children:[a.jsx(l,{className:"w-7 h-7 text-green-600 mb-3"}),a.jsx("span",{className:"text-sm font-semibold text-gray-900",children:"Dashboard"})]})]}),a.jsxs("div",{className:"bg-white rounded-2xl shadow-[0_8px_30px_rgb(0,0,0,0.08)] border border-gray-50 p-5",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsx("h3",{className:"font-bold text-gray-900",children:"Recent"}),a.jsx("button",{onClick:()=>p("/dashboard"),className:"text-sm text-blue-600 font-medium",children:"View All"})]}),a.jsx("div",{className:"space-y-3",children:S?a.jsx("div",{className:"text-center py-8",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"})}):0===(null==C?void 0:C.length)?a.jsxs("div",{className:"text-center py-8",children:[a.jsx(d,{className:"w-12 h-12 mx-auto mb-2 text-gray-200"}),a.jsx("p",{className:"text-gray-400 text-sm",children:"No inspections yet"})]}):null==C?void 0:C.slice(0,5).map(e=>a.jsx("div",{className:"flex items-center justify-between",children:a.jsxs("div",{className:"flex items-center space-x-3",children:[a.jsx("div",{className:"w-10 h-10 rounded-xl flex items-center justify-center "+("completed"===e.overall_status?"bg-green-50":"bg-gray-50"),children:"completed"===e.overall_status?a.jsx(o,{className:"w-5 h-5 text-green-600"}):a.jsx(d,{className:"w-5 h-5 text-gray-400"})}),a.jsxs("div",{children:[a.jsx("div",{className:"font-medium text-gray-900 text-sm",children:e.locations.name}),a.jsx("div",{className:"text-xs text-gray-500",children:u(new Date(e.inspection_date),"dd MMM")})]})]})},e.id))})]})]}),a.jsx(h,{isOpen:y,onClose:()=>f(!1),onScan:async e=>{try{if(!/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e))return void c.error("Invalid location ID format");const{data:s,error:t}=await b.from("locations").select("id, name, is_active, building, floor").eq("id",e).single();if(t||!s)return void c.error("Location not found. Please contact admin.");if(!s.is_active)return void c.error("This location is currently inactive");c.success(`Opening ${s.name}...`),f(!1),p(`/inspect/${s.id}`)}catch(s){c.error("Failed to process QR code")}}})]})};export{g as ScanPage};
